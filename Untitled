<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title></title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="2685.3">
  <style type="text/css">
    p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; font: 15.0px '.AppleSystemUIFontMonospaced'; color: #88b966}
    p.p2 {margin: 0.0px 0.0px 0.0px 0.0px; font: 15.0px '.AppleSystemUIFontMonospaced'; color: #9ba2b1}
    p.p3 {margin: 0.0px 0.0px 0.0px 0.0px; font: 15.0px '.AppleSystemUIFontMonospaced'; color: #d65562}
    p.p4 {margin: 0.0px 0.0px 0.0px 0.0px; font: 15.0px '.AppleSystemUIFontMonospaced'; color: #9ba2b1; min-height: 18.0px}
    p.p5 {margin: 0.0px 0.0px 0.0px 0.0px; font: 15.0px '.AppleSystemUIFontMonospaced'; color: #4a505d}
    p.p6 {margin: 0.0px 0.0px 0.0px 0.0px; font: 15.0px '.AppleSystemUIFontMonospaced'; color: #b85dd5}
    p.p7 {margin: 0.0px 0.0px 0.0px 0.0px; font: 15.0px '.AppleSystemUIFontMonospaced'; color: #c58853}
    span.s1 {color: #b85dd5}
    span.s2 {color: #d65562}
    span.s3 {color: #c58853}
    span.s4 {color: #88b966}
    span.s5 {color: #9ba2b1}
    span.s6 {color: #48a8b5}
  </style>
</head>
<body>
<p class="p1">&lt;!doctype <span class="s1">html</span>&gt;</p>
<p class="p2">&lt;<span class="s2">html</span> <span class="s3">lang</span>=<span class="s4">"en"</span>&gt;</p>
<p class="p3"><span class="s5">&lt;</span>head<span class="s5">&gt;</span></p>
<p class="p2"><span class="Apple-converted-space">Â  </span>&lt;<span class="s2">meta</span> <span class="s3">charset</span>=<span class="s4">"utf-8"</span>/&gt;</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  </span>&lt;</span><span class="s2">meta</span><span class="s5"> </span><span class="s3">name</span><span class="s5">=</span>"viewport"<span class="s5"> </span><span class="s3">content</span><span class="s5">=</span>"width=device-width, initial-scale=1"<span class="s5">/&gt;</span></p>
<p class="p2"><span class="Apple-converted-space">Â  </span>&lt;<span class="s2">title</span>&gt;Mirror&lt;/<span class="s2">title</span>&gt;</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  </span>&lt;</span><span class="s2">meta</span><span class="s5"> </span><span class="s3">name</span><span class="s5">=</span>"color-scheme"<span class="s5"> </span><span class="s3">content</span><span class="s5">=</span>"dark light"<span class="s5">/&gt;</span></p>
<p class="p3"><span class="s5"><span class="Apple-converted-space">Â  </span>&lt;</span>style<span class="s5">&gt;</span></p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>:root{</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>--bg:#0b0f14; --panel:#0f1622; --muted:#9aa7b4; --text:#e7eef6;</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>--line:#1f2b3a; --good:#43d17a; --warn:#f3c969; --bad:#ff5c77; --accent:#7aa7ff;</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>--shadow: 0 10px 30px rgba(0,0,0,.35);</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>--r:16px;</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>}</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>body{ margin:0; background:linear-gradient(120deg,#05070a,#0b0f14 40%, #070b12); color:var(--text); }</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>a{ color:var(--accent); text-decoration:none; }</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>a:hover{ text-decoration:underline; }</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>.wrap{ max-width:1080px; padding:18px; margin:0 auto; }</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>.topbar{</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>display:flex; gap:10px; align-items:center; justify-content:space-between;</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>position:sticky; top:0; backdrop-filter: blur(10px);</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>background: rgba(11,15,20,.7); border-bottom:1px solid var(--line); z-index:10;</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>padding:12px 18px;</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>}</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>.brand{ display:flex; gap:10px; align-items:center; }</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>.logo{</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>width:34px; height:34px; border-radius:10px;</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>background: radial-gradient(circle at 30% 20%, #a5c7ff, #2b5cff 35%, #0c1430 70%);</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>box-shadow: var(--shadow);</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>}</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>.brand h1{ font-size:14px; margin:0; letter-spacing:.4px; }</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>.tag{ font-size:12px; color:var(--muted); }</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>.row{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; }</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>.btn{</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>border:1px solid var(--line); background: rgba(15,22,34,.6); color:var(--text);</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>padding:10px 12px; border-radius:12px; cursor:pointer; transition:.15s;</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>display:inline-flex; gap:8px; align-items:center;</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>}</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>.btn:hover{ transform: translateY(-1px); border-color:#2a3a52; }</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>.btn.primary{ background: linear-gradient(180deg, rgba(122,167,255,.25), rgba(122,167,255,.08)); border-color: rgba(122,167,255,.35); }</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>.btn.danger{ background: rgba(255,92,119,.12); border-color: rgba(255,92,119,.35); }</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>.btn.good{ background: rgba(67,209,122,.12); border-color: rgba(67,209,122,.35); }</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>.btn.ghost{ background: transparent; }</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>.pill{ font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid var(--line); color:var(--muted); }</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>.grid{ display:grid; gap:12px; grid-template-columns: 360px 1fr; align-items:start; }</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>@media(max-width: 980px){ .grid{ grid-template-columns: 1fr; } }</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>.card{</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>background: rgba(15,22,34,.65);</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>border:1px solid var(--line); border-radius: var(--r);</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>box-shadow: var(--shadow);</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>padding:14px;</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>}</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>.card h2{ margin:0 0 8px; font-size:14px; letter-spacing:.3px; }</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>.muted{ color:var(--muted); font-size:12px; line-height:1.45; }</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>.hr{ height:1px; background: var(--line); margin:12px 0; }</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>label{ font-size:12px; color:var(--muted); display:block; margin:10px 0 6px; }</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>input, textarea, select{</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>width:100%; box-sizing:border-box;</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>background: rgba(5,7,10,.5);</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>border:1px solid var(--line);</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>color:var(--text);</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>padding:10px 10px;</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>border-radius: 12px;</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>outline:none;</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>}</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>textarea{ min-height: 96px; resize: vertical; }</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>.split{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>@media(max-width:650px){ .split{ grid-template-columns: 1fr; } }</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>.kpi{ display:flex; gap:10px; flex-wrap:wrap; }</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>.k{ padding:10px 12px; border-radius:14px; border:1px solid var(--line); background: rgba(5,7,10,.35); }</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>.k .n{ font-size:16px; font-weight:700; }</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>.k .l{ font-size:11px; color:var(--muted); }</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>.list{ display:flex; flex-direction:column; gap:8px; }</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>.item{</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>padding:10px 10px; border-radius:14px;</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>border:1px solid var(--line); background: rgba(5,7,10,.35);</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>display:flex; gap:10px; align-items:center; justify-content:space-between;</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>}</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>.small{ font-size:12px; color:var(--muted); }</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>.badge{ font-size:11px; padding:4px 8px; border-radius:999px; border:1px solid var(--line); }</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>.bG{ border-color: rgba(67,209,122,.45); color: var(--good); background: rgba(67,209,122,.1); }</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>.bY{ border-color: rgba(243,201,105,.55); color: var(--warn); background: rgba(243,201,105,.1); }</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>.bR{ border-color: rgba(255,92,119,.55); color: var(--bad); background: rgba(255,92,119,.1); }</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>.hint{ font-size:12px; color:var(--muted); margin-top:8px; }</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>.mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>.toast{</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>position:fixed; bottom:18px; left:50%; transform:translateX(-50%);</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>background: rgba(15,22,34,.9); border:1px solid var(--line);</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>padding:10px 12px; border-radius:12px; box-shadow: var(--shadow);</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>display:none; z-index:50;</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>}</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>.dangerBox{ border:1px solid rgba(255,92,119,.4); background: rgba(255,92,119,.08); padding:12px; border-radius:14px; }</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>.goodBox{ border:1px solid rgba(67,209,122,.35); background: rgba(67,209,122,.08); padding:12px; border-radius:14px; }</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>.warnBox{ border:1px solid rgba(243,201,105,.35); background: rgba(243,201,105,.08); padding:12px; border-radius:14px; }</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>.right{ text-align:right; }</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>.inline{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>.checkRow{ display:flex; gap:10px; flex-wrap:wrap; }</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>.check{</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>border:1px solid var(--line); background: rgba(5,7,10,.35);</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>padding:8px 10px; border-radius: 12px; font-size:12px; color:var(--text);</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>display:flex; gap:8px; align-items:center;</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>}</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>.check input{ width:auto; }</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>&lt;/<span class="s2">style</span>&gt;</p>
<p class="p3"><span class="s5">&lt;/</span>head<span class="s5">&gt;</span></p>
<p class="p3"><span class="s5">&lt;</span>body<span class="s5">&gt;</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  </span>&lt;</span><span class="s2">div</span><span class="s5"> </span><span class="s3">class</span><span class="s5">=</span>"topbar"<span class="s5">&gt;</span></p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>&lt;<span class="s2">div</span> <span class="s3">class</span>=<span class="s4">"brand"</span>&gt;</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>&lt;<span class="s2">div</span> <span class="s3">class</span>=<span class="s4">"logo"</span> <span class="s3">id</span>=<span class="s4">"logo"</span>&gt;&lt;/<span class="s2">div</span>&gt;</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>&lt;<span class="s2">div</span>&gt;</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  </span>&lt;<span class="s2">h1</span> <span class="s3">id</span>=<span class="s4">"appName"</span>&gt;Mirror&lt;/<span class="s2">h1</span>&gt;</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  </span>&lt;<span class="s2">div</span> <span class="s3">class</span>=<span class="s4">"tag"</span> <span class="s3">id</span>=<span class="s4">"appTag"</span>&gt;CBT conflict resolution. Private by default.&lt;/<span class="s2">div</span>&gt;</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>&lt;/<span class="s2">div</span>&gt;</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>&lt;/<span class="s2">div</span>&gt;</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>&lt;<span class="s2">div</span> <span class="s3">class</span>=<span class="s4">"row"</span>&gt;</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>&lt;<span class="s2">span</span> <span class="s3">class</span>=<span class="s4">"pill"</span> <span class="s3">id</span>=<span class="s4">"vaultState"</span>&gt;Locked&lt;/<span class="s2">span</span>&gt;</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  Â  </span>&lt;</span><span class="s2">button</span><span class="s5"> </span><span class="s3">class</span><span class="s5">=</span>"btn danger"<span class="s5"> </span><span class="s3">id</span><span class="s5">=</span>"quickExitBtn"<span class="s5"> </span><span class="s3">title</span><span class="s5">=</span>"Quick Exit (panic)"<span class="s5">&gt;&lt;</span><span class="s2">span</span><span class="s5">&gt;â›”&lt;/</span><span class="s2">span</span><span class="s5">&gt;&lt;</span><span class="s2">span</span><span class="s5">&gt;Quick Exit&lt;/</span><span class="s2">span</span><span class="s5">&gt;&lt;/</span><span class="s2">button</span><span class="s5">&gt;</span></p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>&lt;<span class="s2">button</span> <span class="s3">class</span>=<span class="s4">"btn"</span> <span class="s3">id</span>=<span class="s4">"lockBtn"</span> <span class="s3">style</span>=<span class="s4">"display:none"</span>&gt;&lt;<span class="s2">span</span>&gt;ðŸ”’&lt;/<span class="s2">span</span>&gt;&lt;<span class="s2">span</span>&gt;Lock&lt;/<span class="s2">span</span>&gt;&lt;/<span class="s2">button</span>&gt;</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>&lt;/<span class="s2">div</span>&gt;</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>&lt;/<span class="s2">div</span>&gt;</p>
<p class="p4"><br></p>
<p class="p2"><span class="Apple-converted-space">Â  </span>&lt;<span class="s2">div</span> <span class="s3">class</span>=<span class="s4">"wrap"</span>&gt;</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>&lt;<span class="s2">div</span> <span class="s3">class</span>=<span class="s4">"grid"</span>&gt;</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>&lt;<span class="s2">div</span> <span class="s3">class</span>=<span class="s4">"card"</span>&gt;</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  </span>&lt;<span class="s2">h2</span>&gt;Navigation&lt;/<span class="s2">h2</span>&gt;</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  </span>&lt;<span class="s2">div</span> <span class="s3">class</span>=<span class="s4">"muted"</span> <span class="s3">id</span>=<span class="s4">"navHint"</span>&gt;Unlock to use the app.&lt;/<span class="s2">div</span>&gt;</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  </span>&lt;<span class="s2">div</span> <span class="s3">class</span>=<span class="s4">"hr"</span>&gt;&lt;/<span class="s2">div</span>&gt;</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  </span>&lt;<span class="s2">div</span> <span class="s3">class</span>=<span class="s4">"list"</span> <span class="s3">id</span>=<span class="s4">"nav"</span>&gt;&lt;/<span class="s2">div</span>&gt;</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  </span>&lt;<span class="s2">div</span> <span class="s3">class</span>=<span class="s4">"hr"</span>&gt;&lt;/<span class="s2">div</span>&gt;</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  </span>&lt;<span class="s2">div</span> <span class="s3">class</span>=<span class="s4">"muted"</span>&gt;</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  Â  </span>&lt;<span class="s2">div</span> <span class="s3">class</span>=<span class="s4">"warnBox"</span>&gt;</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>&lt;<span class="s2">b</span>&gt;Safety note:&lt;/<span class="s2">b</span>&gt; This is not emergency support or a substitute for therapy.</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>If thereâ€™s violence, coercion, or outing threats, the app will pivot to safety guidance.</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  Â  </span>&lt;/<span class="s2">div</span>&gt;</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  </span>&lt;/<span class="s2">div</span>&gt;</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>&lt;/<span class="s2">div</span>&gt;</p>
<p class="p4"><br></p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>&lt;<span class="s2">div</span> <span class="s3">class</span>=<span class="s4">"card"</span> <span class="s3">id</span>=<span class="s4">"main"</span>&gt;&lt;/<span class="s2">div</span>&gt;</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>&lt;/<span class="s2">div</span>&gt;</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>&lt;/<span class="s2">div</span>&gt;</p>
<p class="p4"><br></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  </span>&lt;</span><span class="s2">div</span><span class="s5"> </span><span class="s3">class</span><span class="s5">=</span>"toast"<span class="s5"> </span><span class="s3">id</span><span class="s5">=</span>"toast"<span class="s5">&gt;&lt;/</span><span class="s2">div</span><span class="s5">&gt;</span></p>
<p class="p4"><br></p>
<p class="p1"><span class="s5">&lt;</span><span class="s2">script</span><span class="s5"> </span><span class="s3">type</span><span class="s5">=</span>"module"<span class="s5">&gt;</span></p>
<p class="p5">/** =========================================================</p>
<p class="p5"><span class="Apple-converted-space">Â </span>*<span class="Apple-converted-space">Â  </span>MIRROR (Single-file MVP)</p>
<p class="p5"><span class="Apple-converted-space">Â </span>*<span class="Apple-converted-space">Â  </span>- Offline, encrypted local vault</p>
<p class="p5"><span class="Apple-converted-space">Â </span>*<span class="Apple-converted-space">Â  </span>- Couples conflict intake + CBT/fairness report</p>
<p class="p5"><span class="Apple-converted-space">Â </span>*<span class="Apple-converted-space">Â  </span>- Stealth mode + quick exit</p>
<p class="p5"><span class="Apple-converted-space">Â </span>*<span class="Apple-converted-space">Â  </span>========================================================= */</p>
<p class="p4"><br></p>
<p class="p2"><span class="s1">const</span> $ = (sel) =&gt; document.querySelector(sel);</p>
<p class="p2"><span class="s1">const</span> el = (tag, attrs={}, children=[]) =&gt; {</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> n = document.createElement(tag);</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">for</span> (<span class="s1">const</span> [k,v] <span class="s1">of</span> Object.entries(attrs)) {</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span><span class="s1">if</span> (k === <span class="s4">"class"</span>) n.className = v;</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span><span class="s1">else</span> <span class="s1">if</span> (k === <span class="s4">"html"</span>) n.innerHTML = v;</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span><span class="s1">else</span> <span class="s1">if</span> (k.startsWith(<span class="s4">"on"</span>) &amp;&amp; <span class="s1">typeof</span> v === <span class="s4">"function"</span>) n.addEventListener(k.slice(<span class="s3">2</span>), v);</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span><span class="s1">else</span> n.setAttribute(k, v);</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>}</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">for</span> (<span class="s1">const</span> c <span class="s1">of</span> children) n.append(c);</p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">Â  </span></span>return<span class="s5"> n;</span></p>
<p class="p2">};</p>
<p class="p4"><br></p>
<p class="p2"><span class="s1">const</span> toast = (msg) =&gt; {</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> t = $(<span class="s4">"#toast"</span>);</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>t.textContent = msg;</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>t.style.display = <span class="s4">"block"</span>;</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>clearTimeout(toast._to);</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>toast._to = setTimeout(()=&gt; t.style.display=<span class="s4">"none"</span>, <span class="s3">2200</span>);</p>
<p class="p2">};</p>
<p class="p4"><br></p>
<p class="p1"><span class="s1">const</span><span class="s5"> STORAGE_KEY = </span>"mirror_vault_v1"<span class="s5">;</span></p>
<p class="p1"><span class="s1">const</span><span class="s5"> META_KEY = </span>"mirror_meta_v1"<span class="s5">;</span></p>
<p class="p4"><br></p>
<p class="p5">/** -----------------------------</p>
<p class="p5"><span class="Apple-converted-space">Â </span>*<span class="Apple-converted-space">Â  </span>Basic state</p>
<p class="p5"><span class="Apple-converted-space">Â </span>*<span class="Apple-converted-space">Â  </span>----------------------------- */</p>
<p class="p2"><span class="s1">let</span> state = {</p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">Â  </span></span>locked<span class="s5">: </span><span class="s6">true</span><span class="s5">,</span></p>
<p class="p5"><span class="s5"><span class="Apple-converted-space">Â  </span></span><span class="s3">key</span><span class="s5">: </span><span class="s6">null</span><span class="s5">, </span>// CryptoKey in memory only</p>
<p class="p5"><span class="s5"><span class="Apple-converted-space">Â  </span></span><span class="s3">vault</span><span class="s5">: </span><span class="s6">null</span><span class="s5">, </span>// decrypted object</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  </span></span><span class="s3">view</span><span class="s5">: </span>"LOCK"<span class="s5">,</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">Â  </span></span>selected<span class="s5">: {</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">Â  Â  </span></span>relationshipId<span class="s5">: </span><span class="s6">null</span><span class="s5">,</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">Â  Â  </span></span>conflictId<span class="s5">: </span><span class="s6">null</span><span class="s5">,</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">Â  Â  </span></span>activePartnerId<span class="s5">: </span><span class="s6">null</span><span class="s5">,</span></p>
<p class="p2"><span class="Apple-converted-space">Â  </span>}</p>
<p class="p2">};</p>
<p class="p4"><br></p>
<p class="p5">/** -----------------------------</p>
<p class="p5"><span class="Apple-converted-space">Â </span>*<span class="Apple-converted-space">Â  </span>Default vault shape</p>
<p class="p5"><span class="Apple-converted-space">Â </span>*<span class="Apple-converted-space">Â  </span>----------------------------- */</p>
<p class="p2"><span class="s1">function</span> defaultVault() {</p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">Â  </span></span>return<span class="s5"> {</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">Â  Â  </span></span>version<span class="s5">: </span>1<span class="s5">,</span></p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span><span class="s3">createdAt</span>: <span class="s1">new</span> Date().toISOString(),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span><span class="s3">users</span>: [],</p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">Â  Â  </span></span>relationships<span class="s5">: [],</span></p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span><span class="s3">conflicts</span>: [],</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span><span class="s3">checkins</span>: [],</p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">Â  Â  </span></span>settings<span class="s5">: {</span></p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span><span class="s3">stealth</span>: <span class="s6">false</span>,</p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">Â  Â  Â  </span></span>autoLockMinutes<span class="s5">: </span>10<span class="s5">,</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">Â  Â  Â  </span></span>pinEnabled<span class="s5">: </span><span class="s6">false</span><span class="s5">,</span></p>
<p class="p5"><span class="s5"><span class="Apple-converted-space">Â  Â  Â  </span></span><span class="s3">pinVerifier</span><span class="s5">: </span><span class="s6">null</span><span class="s5">, </span>// {saltB64, ivB64, ctB64} encrypted blob verifying pin</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  Â  </span></span><span class="s3">appAlias</span><span class="s5">: { </span><span class="s3">name</span><span class="s5">: </span>"Mirror"<span class="s5">, </span><span class="s3">tag</span><span class="s5">: </span>"CBT conflict resolution. Private by default."<span class="s5"> },</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  Â  </span></span><span class="s3">stealthAlias</span><span class="s5">: { </span><span class="s3">name</span><span class="s5">: </span>"Notes"<span class="s5">, </span><span class="s3">tag</span><span class="s5">: </span>"Private notes. Offline."<span class="s5"> }</span></p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>}</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>};</p>
<p class="p2">}</p>
<p class="p4"><br></p>
<p class="p5">/** -----------------------------</p>
<p class="p5"><span class="Apple-converted-space">Â </span>*<span class="Apple-converted-space">Â  </span>Crypto helpers (WebCrypto)</p>
<p class="p5"><span class="Apple-converted-space">Â </span>*<span class="Apple-converted-space">Â  </span>- AES-GCM encryption</p>
<p class="p5"><span class="Apple-converted-space">Â </span>*<span class="Apple-converted-space">Â  </span>- PBKDF2 key derivation from passphrase / PIN</p>
<p class="p5"><span class="Apple-converted-space">Â </span>*<span class="Apple-converted-space">Â  </span>----------------------------- */</p>
<p class="p2"><span class="s1">const</span> enc = <span class="s1">new</span> TextEncoder();</p>
<p class="p2"><span class="s1">const</span> dec = <span class="s1">new</span> TextDecoder();</p>
<p class="p4"><br></p>
<p class="p2"><span class="s1">function</span> b64(bytes) {</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">return</span> btoa(String.fromCharCode(...bytes));</p>
<p class="p2">}</p>
<p class="p2"><span class="s1">function</span> unb64(str) {</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">return</span> Uint8Array.from(atob(str), c =&gt; c.charCodeAt(<span class="s3">0</span>));</p>
<p class="p2">}</p>
<p class="p2"><span class="s1">function</span> randBytes(n) {</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> a = <span class="s1">new</span> Uint8Array(n);</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>crypto.getRandomValues(a);</p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">Â  </span></span>return<span class="s5"> a;</span></p>
<p class="p2">}</p>
<p class="p4"><br></p>
<p class="p2"><span class="s1">async</span> <span class="s1">function</span> deriveKeyFromSecret(secret, saltBytes, iterations=<span class="s3">200000</span>) {</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> baseKey = <span class="s1">await</span> crypto.subtle.importKey(</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span><span class="s4">"raw"</span>,</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>enc.encode(secret),</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span></span>"PBKDF2"<span class="s5">,</span></p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span><span class="s6">false</span>,</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span>[</span>"deriveKey"<span class="s5">]</span></p>
<p class="p2"><span class="Apple-converted-space">Â  </span>);</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">return</span> crypto.subtle.deriveKey(</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>{ <span class="s3">name</span>: <span class="s4">"PBKDF2"</span>, <span class="s3">salt</span>: saltBytes, iterations, <span class="s3">hash</span>: <span class="s4">"SHA-256"</span> },</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>baseKey,</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>{ <span class="s3">name</span>: <span class="s4">"AES-GCM"</span>, <span class="s3">length</span>: <span class="s3">256</span> },</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span><span class="s6">false</span>,</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span>[</span>"encrypt"<span class="s5">,</span>"decrypt"<span class="s5">]</span></p>
<p class="p2"><span class="Apple-converted-space">Â  </span>);</p>
<p class="p2">}</p>
<p class="p4"><br></p>
<p class="p2"><span class="s1">async</span> <span class="s1">function</span> encryptJson(key, obj) {</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> iv = randBytes(<span class="s3">12</span>);</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> plaintext = enc.encode(JSON.stringify(obj));</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> ct = <span class="s1">new</span> Uint8Array(<span class="s1">await</span> crypto.subtle.encrypt({<span class="s3">name</span>:<span class="s4">"AES-GCM"</span>, iv}, key, plaintext));</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">return</span> { <span class="s3">ivB64</span>: b64(iv), <span class="s3">ctB64</span>: b64(ct) };</p>
<p class="p2">}</p>
<p class="p2"><span class="s1">async</span> <span class="s1">function</span> decryptJson(key, payload) {</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> iv = unb64(payload.ivB64);</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> ct = unb64(payload.ctB64);</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> pt = <span class="s1">await</span> crypto.subtle.decrypt({<span class="s3">name</span>:<span class="s4">"AES-GCM"</span>, iv}, key, ct);</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">return</span> JSON.parse(dec.decode(pt));</p>
<p class="p2">}</p>
<p class="p4"><br></p>
<p class="p2"><span class="s1">function</span> loadMeta() {</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">try</span> { <span class="s1">return</span> JSON.parse(localStorage.getItem(META_KEY) || <span class="s4">"null"</span>); } <span class="s1">catch</span> { <span class="s1">return</span> <span class="s6">null</span>; }</p>
<p class="p2">}</p>
<p class="p2"><span class="s1">function</span> saveMeta(meta) {</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>localStorage.setItem(META_KEY, JSON.stringify(meta));</p>
<p class="p2">}</p>
<p class="p4"><br></p>
<p class="p2"><span class="s1">async</span> <span class="s1">function</span> saveVault() {</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">if</span> (!state.key || !state.vault) <span class="s1">return</span>;</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> meta = loadMeta();</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">if</span> (!meta?.saltB64) <span class="s1">throw</span> <span class="s1">new</span> Error(<span class="s4">"Missing vault meta salt."</span>);</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> encrypted = <span class="s1">await</span> encryptJson(state.key, state.vault);</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>localStorage.setItem(STORAGE_KEY, JSON.stringify(encrypted));</p>
<p class="p2">}</p>
<p class="p4"><br></p>
<p class="p2"><span class="s1">async</span> <span class="s1">function</span> createNewVault(passphrase) {</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> salt = randBytes(<span class="s3">16</span>);</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> key = <span class="s1">await</span> deriveKeyFromSecret(passphrase, salt);</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> vault = defaultVault();</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>saveMeta({ <span class="s3">saltB64</span>: b64(salt), <span class="s3">createdAt</span>: <span class="s1">new</span> Date().toISOString() });</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> encrypted = <span class="s1">await</span> encryptJson(key, vault);</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>localStorage.setItem(STORAGE_KEY, JSON.stringify(encrypted));</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>state.key = key;</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>state.vault = vault;</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>state.locked = <span class="s6">false</span>;</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>state.view = <span class="s4">"DASH"</span>;</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>applyBranding();</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>render();</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  </span>toast(</span>"Vault created + unlocked."<span class="s5">);</span></p>
<p class="p2">}</p>
<p class="p4"><br></p>
<p class="p2"><span class="s1">async</span> <span class="s1">function</span> unlockVaultWithPassphrase(passphrase) {</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> meta = loadMeta();</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">if</span> (!meta?.saltB64) <span class="s1">throw</span> <span class="s1">new</span> Error(<span class="s4">"No vault meta found."</span>);</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> salt = unb64(meta.saltB64);</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> key = <span class="s1">await</span> deriveKeyFromSecret(passphrase, salt);</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> blob = JSON.parse(localStorage.getItem(STORAGE_KEY) || <span class="s4">"null"</span>);</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  </span></span><span class="s1">if</span><span class="s5"> (!blob) </span><span class="s1">throw</span><span class="s5"> </span><span class="s1">new</span><span class="s5"> Error(</span>"No vault data found."<span class="s5">);</span></p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> vault = <span class="s1">await</span> decryptJson(key, blob);</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>state.key = key;</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>state.vault = vault;</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>state.locked = <span class="s6">false</span>;</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>state.view = <span class="s4">"DASH"</span>;</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>applyBranding();</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>render();</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  </span>toast(</span>"Unlocked."<span class="s5">);</span></p>
<p class="p2">}</p>
<p class="p4"><br></p>
<p class="p2"><span class="s1">async</span> <span class="s1">function</span> setPin(pin) {</p>
<p class="p5"><span class="s5"><span class="Apple-converted-space">Â  </span></span>// Store a verifier we can decrypt with PIN-derived key. If decrypt works and matches, PIN is correct.</p>
<p class="p5"><span class="s5"><span class="Apple-converted-space">Â  </span></span>// This is not "magic security", it's just practical.</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> salt = randBytes(<span class="s3">16</span>);</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> key = <span class="s1">await</span> deriveKeyFromSecret(pin, salt, <span class="s3">120000</span>);</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> payload = <span class="s1">await</span> encryptJson(key, { <span class="s3">ok</span>:<span class="s6">true</span>, <span class="s3">t</span>: Date.now() });</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>state.vault.settings.pinEnabled = <span class="s6">true</span>;</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>state.vault.settings.pinVerifier = { <span class="s3">saltB64</span>: b64(salt), ...payload };</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">await</span> saveVault();</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  </span>toast(</span>"PIN enabled."<span class="s5">);</span></p>
<p class="p2">}</p>
<p class="p4"><br></p>
<p class="p2"><span class="s1">async</span> <span class="s1">function</span> tryUnlockWithPin(pin) {</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> v = state.vault?.settings?.pinVerifier;</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">if</span> (!v) <span class="s1">throw</span> <span class="s1">new</span> Error(<span class="s4">"No PIN verifier."</span>);</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> salt = unb64(v.saltB64);</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> key = <span class="s1">await</span> deriveKeyFromSecret(pin, salt, <span class="s3">120000</span>);</p>
<p class="p5"><span class="s5"><span class="Apple-converted-space">Â  </span></span>// attempt decrypt verifier</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">await</span> decryptJson(key, {<span class="s3">ivB64</span>: v.ivB64, <span class="s3">ctB64</span>: v.ctB64});</p>
<p class="p5"><span class="s5"><span class="Apple-converted-space">Â  </span></span>// if success, derive actual vault key from PIN? No. We still need passphrase for real vault.</p>
<p class="p5"><span class="s5"><span class="Apple-converted-space">Â  </span></span>// Practical approach: When unlocked with passphrase, user can enable a "PIN wraps passphrase" scheme.</p>
<p class="p5"><span class="s5"><span class="Apple-converted-space">Â  </span></span>// For MVP: PIN only gates the UI while *key stays in memory* until auto-lock.</p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">Â  </span></span>return<span class="s5"> </span><span class="s6">true</span><span class="s5">;</span></p>
<p class="p2">}</p>
<p class="p4"><br></p>
<p class="p5">/** -----------------------------</p>
<p class="p5"><span class="Apple-converted-space">Â </span>*<span class="Apple-converted-space">Â  </span>Auto-lock timer</p>
<p class="p5"><span class="Apple-converted-space">Â </span>*<span class="Apple-converted-space">Â  </span>----------------------------- */</p>
<p class="p2"><span class="s1">let</span> lockTimer = <span class="s6">null</span>;</p>
<p class="p2"><span class="s1">function</span> armAutoLock() {</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>clearTimeout(lockTimer);</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">if</span> (state.locked) <span class="s1">return</span>;</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> mins = Math.max(<span class="s3">1</span>, state.vault?.settings?.autoLockMinutes || <span class="s3">10</span>);</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>lockTimer = setTimeout(() =&gt; doLock(<span class="s4">"Auto-locked."</span>), mins * <span class="s3">60</span> * <span class="s3">1000</span>);</p>
<p class="p2">}</p>
<p class="p2">[<span class="s4">"click"</span>,<span class="s4">"keydown"</span>,<span class="s4">"mousemove"</span>,<span class="s4">"touchstart"</span>].forEach(ev =&gt; window.addEventListener(ev, armAutoLock, {<span class="s3">passive</span>:<span class="s6">true</span>}));</p>
<p class="p4"><br></p>
<p class="p2"><span class="s1">function</span> doLock(msg=<span class="s4">"Locked."</span>) {</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>state.locked = <span class="s6">true</span>;</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>state.key = <span class="s6">null</span>;</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>state.vault = <span class="s6">null</span>;</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>state.view = <span class="s4">"LOCK"</span>;</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>$(<span class="s4">"#lockBtn"</span>).style.display = <span class="s4">"none"</span>;</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>$(<span class="s4">"#vaultState"</span>).textContent = <span class="s4">"Locked"</span>;</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>$(<span class="s4">"#vaultState"</span>).className = <span class="s4">"pill"</span>;</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>applyBranding(<span class="s6">true</span>);</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>render();</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>toast(msg);</p>
<p class="p2">}</p>
<p class="p4"><br></p>
<p class="p5">/** -----------------------------</p>
<p class="p5"><span class="Apple-converted-space">Â </span>*<span class="Apple-converted-space">Â  </span>Stealth mode branding</p>
<p class="p5"><span class="Apple-converted-space">Â </span>*<span class="Apple-converted-space">Â  </span>----------------------------- */</p>
<p class="p2"><span class="s1">function</span> makeFaviconDataURI(type=<span class="s4">"normal"</span>) {</p>
<p class="p5"><span class="s5"><span class="Apple-converted-space">Â  </span></span>// tiny svg favicons as data URI</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  </span></span><span class="s1">const</span><span class="s5"> normal = </span>`&lt;svg xmlns="http://www.w3.org/2000/svg" width="64" height="64"&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>&lt;defs&gt;&lt;radialGradient id="g" cx="30%" cy="20%"&gt;&lt;stop offset="0" stop-color="#a5c7ff"/&gt;&lt;stop offset="0.35" stop-color="#2b5cff"/&gt;&lt;stop offset="1" stop-color="#0c1430"/&gt;&lt;/radialGradient&gt;&lt;/defs&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>&lt;rect rx="16" ry="16" width="64" height="64" fill="url(#g)"/&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>&lt;circle cx="38" cy="26" r="10" fill="rgba(255,255,255,.25)"/&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  </span>&lt;/svg&gt;`<span class="s5">;</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  </span></span><span class="s1">const</span><span class="s5"> stealth = </span>`&lt;svg xmlns="http://www.w3.org/2000/svg" width="64" height="64"&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>&lt;rect rx="16" ry="16" width="64" height="64" fill="#111827"/&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>&lt;path d="M18 46h28" stroke="#9aa7b4" stroke-width="6" stroke-linecap="round"/&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>&lt;path d="M18 34h20" stroke="#9aa7b4" stroke-width="6" stroke-linecap="round" opacity="0.9"/&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>&lt;path d="M18 22h24" stroke="#9aa7b4" stroke-width="6" stroke-linecap="round" opacity="0.75"/&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  </span>&lt;/svg&gt;`<span class="s5">;</span></p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> svg = type===<span class="s4">"stealth"</span> ? stealth : normal;</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  </span></span><span class="s1">return</span><span class="s5"> </span>"data:image/svg+xml;base64,"<span class="s5"> + btoa(svg);</span></p>
<p class="p2">}</p>
<p class="p4"><br></p>
<p class="p2"><span class="s1">function</span> applyBranding(lockedOverride=<span class="s6">false</span>) {</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> stealth = !!(state.vault?.settings?.stealth);</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> name = stealth ? state.vault.settings.stealthAlias.name : state.vault?.settings?.appAlias?.name || <span class="s4">"Mirror"</span>;</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> tag = stealth ? state.vault.settings.stealthAlias.tag : state.vault?.settings?.appAlias?.tag || <span class="s4">"CBT conflict resolution. Private by default."</span>;</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>$(<span class="s4">"#appName"</span>).textContent = (lockedOverride ? <span class="s4">"Mirror"</span> : name);</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  </span>$(</span>"#appTag"<span class="s5">).textContent = (lockedOverride ? </span>"CBT conflict resolution. Private by default."<span class="s5"> : tag);</span></p>
<p class="p2"><span class="Apple-converted-space">Â  </span>document.title = (lockedOverride ? <span class="s4">"Mirror"</span> : name);</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>$(<span class="s4">"#logo"</span>).style.background = stealth</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span>? </span>"linear-gradient(180deg,#111827,#0b0f14)"</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span>: </span>"radial-gradient(circle at 30% 20%, #a5c7ff, #2b5cff 35%, #0c1430 70%)"<span class="s5">;</span></p>
<p class="p4"><br></p>
<p class="p5"><span class="s5"><span class="Apple-converted-space">Â  </span></span>// favicon</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">let</span> link = document.querySelector(<span class="s4">'link[rel="icon"]'</span>);</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">if</span> (!link) {</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>link = document.createElement(<span class="s4">"link"</span>);</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>link.rel = <span class="s4">"icon"</span>;</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>document.head.appendChild(link);</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>}</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>link.href = makeFaviconDataURI(lockedOverride ? <span class="s4">"normal"</span> : (stealth ? <span class="s4">"stealth"</span> : <span class="s4">"normal"</span>));</p>
<p class="p2">}</p>
<p class="p4"><br></p>
<p class="p5">/** -----------------------------</p>
<p class="p5"><span class="Apple-converted-space">Â </span>*<span class="Apple-converted-space">Â  </span>Quick exit</p>
<p class="p5"><span class="Apple-converted-space">Â </span>*<span class="Apple-converted-space">Â  </span>----------------------------- */</p>
<p class="p2">$(<span class="s4">"#quickExitBtn"</span>).addEventListener(<span class="s4">"click"</span>, () =&gt; {</p>
<p class="p5"><span class="s5"><span class="Apple-converted-space">Â  </span></span>// dump UI quickly to something boring</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  </span>window.location.href = </span>"https://www.bbc.co.uk/weather"<span class="s5">;</span></p>
<p class="p2">});</p>
<p class="p4"><br></p>
<p class="p5">/** -----------------------------</p>
<p class="p5"><span class="Apple-converted-space">Â </span>*<span class="Apple-converted-space">Â  </span>IDs</p>
<p class="p5"><span class="Apple-converted-space">Â </span>*<span class="Apple-converted-space">Â  </span>----------------------------- */</p>
<p class="p2"><span class="s1">function</span> uid(prefix=<span class="s4">"id"</span>) {</p>
<p class="p3"><span class="s5"><span class="Apple-converted-space">Â  </span></span><span class="s1">return</span><span class="s5"> </span><span class="s4">`</span>${prefix}<span class="s4">_</span>${Math.random().toString(<span class="s3">16</span>).slice(<span class="s3">2</span>)}<span class="s4">_</span>${Date.now().toString(<span class="s3">16</span>)}<span class="s4">`</span><span class="s5">;</span></p>
<p class="p2">}</p>
<p class="p4"><br></p>
<p class="p5">/** -----------------------------</p>
<p class="p5"><span class="Apple-converted-space">Â </span>*<span class="Apple-converted-space">Â  </span>CBT + Safety Heuristics</p>
<p class="p5"><span class="Apple-converted-space">Â </span>*<span class="Apple-converted-space">Â  </span>----------------------------- */</p>
<p class="p2"><span class="s1">const</span> Distortions = [</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  </span>{ </span><span class="s3">name</span><span class="s5">:</span>"Mind reading"<span class="s5">, </span><span class="s3">re</span><span class="s5">:</span>/\b(obviously|clearly|i know you|you think|you just want)\b/i<span class="s5">, </span><span class="s3">tip</span><span class="s5">:</span>"Stop pretending you can read minds. Ask a direct question or state uncertainty."<span class="s5"> },</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  </span>{ </span><span class="s3">name</span><span class="s5">:</span>"Catastrophizing"<span class="s5">, </span><span class="s3">re</span><span class="s5">:</span>/\b(it'?s over|ruined|destroyed|never recover|always ends)\b/i<span class="s5">, </span><span class="s3">tip</span><span class="s5">:</span>"Scale it. Whatâ€™s the most likely outcome, not the nightmare outcome?"<span class="s5"> },</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  </span>{ </span><span class="s3">name</span><span class="s5">:</span>"Overgeneralizing"<span class="s5">, </span><span class="s3">re</span><span class="s5">:</span>/\b(always|never|every time|nothing ever)\b/i<span class="s5">, </span><span class="s3">tip</span><span class="s5">:</span>"Swap absolutes for specifics. Use dates/events, not â€˜always/neverâ€™."<span class="s5"> },</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  </span>{ </span><span class="s3">name</span><span class="s5">:</span>"Labeling"<span class="s5">, </span><span class="s3">re</span><span class="s5">:</span>/\b(you('?re| are) (selfish|crazy|pathetic|toxic|lazy|disgusting))\b/i<span class="s5">, </span><span class="s3">tip</span><span class="s5">:</span>"Attack the behavior, not the person. Labels escalate fights fast."<span class="s5"> },</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  </span>{ </span><span class="s3">name</span><span class="s5">:</span>"Fortune-telling"<span class="s5">, </span><span class="s3">re</span><span class="s5">:</span>/\b(i know this will|you'?ll just|you will)\b/i<span class="s5">, </span><span class="s3">tip</span><span class="s5">:</span>"Predict less. Verify more."<span class="s5"> },</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  </span>{ </span><span class="s3">name</span><span class="s5">:</span>"Should statements"<span class="s5">, </span><span class="s3">re</span><span class="s5">:</span>/\b(should|must|supposed to)\b/i<span class="s5">, </span><span class="s3">tip</span><span class="s5">:</span>"Trade â€˜shouldâ€™ for â€˜Iâ€™d prefer / I needâ€™ and negotiate realities."<span class="s5"> },</span></p>
<p class="p2">];</p>
<p class="p4"><br></p>
<p class="p2"><span class="s1">const</span> ToneFlags = [</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  </span>{ </span><span class="s3">name</span><span class="s5">:</span>"Blame language"<span class="s5">, </span><span class="s3">re</span><span class="s5">:</span>/\b(you made me|your fault|because of you)\b/i<span class="s5"> },</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  </span>{ </span><span class="s3">name</span><span class="s5">:</span>"Ultimatum / threat"<span class="s5">, </span><span class="s3">re</span><span class="s5">:</span>/\b(i'?m leaving|we'?re done|break up|divorce|i will expose|i will tell your family|i'?ll out you)\b/i<span class="s5"> },</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  </span>{ </span><span class="s3">name</span><span class="s5">:</span>"Contempt / insult"<span class="s5">, </span><span class="s3">re</span><span class="s5">:</span>/\b(idiot|stupid|ugly|worthless|cunt|bitch|slut|whore)\b/i<span class="s5"> },</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  </span>{ </span><span class="s3">name</span><span class="s5">:</span>"Scorekeeping"<span class="s5">, </span><span class="s3">re</span><span class="s5">:</span>/\b(after everything i'?ve done|i do everything|you do nothing)\b/i<span class="s5"> },</span></p>
<p class="p2">];</p>
<p class="p4"><br></p>
<p class="p2"><span class="s1">const</span> SafetySignals = [</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  </span>{ </span><span class="s3">type</span><span class="s5">:</span>"Physical harm threat"<span class="s5">, </span><span class="s3">re</span><span class="s5">:</span>/\b(hit|punch|slap|kill|choke|hurt you|beat you)\b/i<span class="s5"> },</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  </span>{ </span><span class="s3">type</span><span class="s5">:</span>"Coercive control"<span class="s5">, </span><span class="s3">re</span><span class="s5">:</span>/\b(tracked your phone|checked your location|wouldn'?t let me leave|blocked the door|took my keys|took my money)\b/i<span class="s5"> },</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  </span>{ </span><span class="s3">type</span><span class="s5">:</span>"Outing threat"<span class="s5">, </span><span class="s3">re</span><span class="s5">:</span>/\b(i'?ll out you|tell your family you'?re (gay|bi|trans)|expose your sexuality|tell your work)\b/i<span class="s5"> },</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  </span>{ </span><span class="s3">type</span><span class="s5">:</span>"Sexual coercion"<span class="s5">, </span><span class="s3">re</span><span class="s5">:</span>/\b(forced|made me have sex|coerced|wouldn'?t take no)\b/i<span class="s5"> },</span></p>
<p class="p2">];</p>
<p class="p4"><br></p>
<p class="p2"><span class="s1">const</span> BehaviorCatalog = {</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s3">green</span>: [</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span>{ </span><span class="s3">k</span><span class="s5">:</span>"usedIStatements"<span class="s5">, </span><span class="s3">t</span><span class="s5">:</span>"Used 'I feel / I need' language"<span class="s5"> },</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span>{ </span><span class="s3">k</span><span class="s5">:</span>"askedClarifying"<span class="s5">, </span><span class="s3">t</span><span class="s5">:</span>"Asked clarifying questions"<span class="s5"> },</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span>{ </span><span class="s3">k</span><span class="s5">:</span>"tookBreakProperly"<span class="s5">, </span><span class="s3">t</span><span class="s5">:</span>"Took a break with a time to resume"<span class="s5"> },</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span>{ </span><span class="s3">k</span><span class="s5">:</span>"apologized"<span class="s5">, </span><span class="s3">t</span><span class="s5">:</span>"Apologized for tone/impact"<span class="s5"> },</span></p>
<p class="p2"><span class="Apple-converted-space">Â  </span>],</p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">Â  </span></span>yellow<span class="s5">: [</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span>{ </span><span class="s3">k</span><span class="s5">:</span>"broughtOldStuff"<span class="s5">, </span><span class="s3">t</span><span class="s5">:</span>"Dragged old issues into it"<span class="s5"> },</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span>{ </span><span class="s3">k</span><span class="s5">:</span>"stonewalled"<span class="s5">, </span><span class="s3">t</span><span class="s5">:</span>"Went silent / disengaged without stating a plan"<span class="s5"> },</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span>{ </span><span class="s3">k</span><span class="s5">:</span>"sarcasm"<span class="s5">, </span><span class="s3">t</span><span class="s5">:</span>"Used sarcasm / passive aggression"<span class="s5"> },</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span>{ </span><span class="s3">k</span><span class="s5">:</span>"raisedVoice"<span class="s5">, </span><span class="s3">t</span><span class="s5">:</span>"Raised voice"<span class="s5"> },</span></p>
<p class="p2"><span class="Apple-converted-space">Â  </span>],</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s3">red</span>: [</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span>{ </span><span class="s3">k</span><span class="s5">:</span>"insults"<span class="s5">, </span><span class="s3">t</span><span class="s5">:</span>"Used insults / name-calling"<span class="s5"> },</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span>{ </span><span class="s3">k</span><span class="s5">:</span>"threatLeaving"<span class="s5">, </span><span class="s3">t</span><span class="s5">:</span>"Threatened leaving/breakup to win"<span class="s5"> },</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span>{ </span><span class="s3">k</span><span class="s5">:</span>"weaponizedVuln"<span class="s5">, </span><span class="s3">t</span><span class="s5">:</span>"Used trauma/identity as a weapon"<span class="s5"> },</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span>{ </span><span class="s3">k</span><span class="s5">:</span>"outingThreat"<span class="s5">, </span><span class="s3">t</span><span class="s5">:</span>"Threatened outing / exposure"<span class="s5"> },</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span>{ </span><span class="s3">k</span><span class="s5">:</span>"followedAndCornered"<span class="s5">, </span><span class="s3">t</span><span class="s5">:</span>"Followed/cornered during a pause request"<span class="s5"> },</span></p>
<p class="p2"><span class="Apple-converted-space">Â  </span>]</p>
<p class="p2">};</p>
<p class="p4"><br></p>
<p class="p2"><span class="s1">const</span> FairnessAreas = [</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  </span></span>"Time &amp; attention"<span class="s5">,</span>"Money"<span class="s5">,</span>"Chores"<span class="s5">,</span>"Emotional support"<span class="s5">,</span>"Intimacy"<span class="s5">,</span>"Decision-making"<span class="s5">,</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  </span></span>"Respect/tone"<span class="s5">,</span>"Friends/social life"<span class="s5">,</span>"Family"<span class="s5">,</span>"Outness/visibility"<span class="s5">,</span>"Privacy/phones"<span class="s5">,</span>"Trust/cheating fears"<span class="s5">,</span>"Safety/public PDA"</p>
<p class="p2">];</p>
<p class="p4"><br></p>
<p class="p2"><span class="s1">function</span> analyzeText(text=<span class="s4">""</span>) {</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> hits = {</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span><span class="s3">distortions</span>: Distortions.filter(d =&gt; d.re.test(text)).map(d =&gt; ({<span class="s3">name</span>:d.name, <span class="s3">tip</span>:d.tip})),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span><span class="s3">tone</span>: ToneFlags.filter(t =&gt; t.re.test(text)).map(t =&gt; t.name),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span><span class="s3">safety</span>: SafetySignals.filter(s =&gt; s.re.test(text)).map(s =&gt; s.type),</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>};</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">return</span> hits;</p>
<p class="p2">}</p>
<p class="p4"><br></p>
<p class="p2"><span class="s1">function</span> summarizeTheme(intakes) {</p>
<p class="p5"><span class="s5"><span class="Apple-converted-space">Â  </span></span>// crude theme inference: look at fairness areas + common keywords</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> areas = <span class="s1">new</span> Map();</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> joined = Object.values(intakes).map(i =&gt; (i.facts+<span class="s4">" "</span>+i.thoughts+<span class="s4">" "</span>+i.context)).join(<span class="s4">" "</span>).toLowerCase();</p>
<p class="p4"><br></p>
<p class="p2"><span class="Apple-converted-space">Â  </span>Object.values(intakes).forEach(i =&gt; (i.fairnessAreas||[]).forEach(a =&gt; areas.set(a,(areas.get(a)||<span class="s3">0</span>)+<span class="s3">1</span>)));</p>
<p class="p4"><br></p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> topArea = [...areas.entries()].sort((a,b)=&gt;b[<span class="s3">1</span>]-a[<span class="s3">1</span>])[<span class="s3">0</span>]?.[<span class="s3">0</span>] || <span class="s4">"Respect/tone"</span>;</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  </span></span><span class="s1">let</span><span class="s5"> headline = </span>"You are not fighting about the surface issue. You are fighting about needs and trust colliding."<span class="s5">;</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  </span></span><span class="s1">if</span><span class="s5"> (topArea===</span>"Privacy/phones"<span class="s5">) headline = </span>"You are not fighting about a phone. You are fighting about trust, control, and reassurance."<span class="s5">;</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  </span></span><span class="s1">if</span><span class="s5"> (topArea===</span>"Outness/visibility"<span class="s5">) headline = </span>"You are not fighting about â€˜PDAâ€™. You are fighting about safety vs being seen."<span class="s5">;</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  </span></span><span class="s1">if</span><span class="s5"> (topArea===</span>"Chores"<span class="s5">) headline = </span>"You are not fighting about chores. You are fighting about fairness and feeling taken for granted."<span class="s5">;</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  </span></span><span class="s1">if</span><span class="s5"> (topArea===</span>"Time &amp; attention"<span class="s5">) headline = </span>"You are not fighting about a single moment. You are fighting about priority and reassurance."<span class="s5">;</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  </span></span><span class="s1">if</span><span class="s5"> (topArea===</span>"Respect/tone"<span class="s5">) headline = </span>"You are not fighting about the topic. You are fighting about disrespect and emotional safety."<span class="s5">;</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  </span></span><span class="s1">if</span><span class="s5"> (joined.includes(</span>"ignored"<span class="s5">) || joined.includes(</span>"left on read"<span class="s5">)) headline = </span>"You are not fighting about messages. You are fighting about felt importance and abandonment alarms."<span class="s5">;</span></p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">return</span> { topArea, headline };</p>
<p class="p2">}</p>
<p class="p4"><br></p>
<p class="p2"><span class="s1">function</span> mergeFacts(intakes, userById) {</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> parts = [];</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">for</span> (<span class="s1">const</span> [uid, i] <span class="s1">of</span> Object.entries(intakes)) {</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span><span class="s1">const</span> name = userById(uid)?.displayName || <span class="s4">"Partner"</span>;</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span><span class="s1">if</span> (i.facts?.trim()) parts.push(<span class="s4">`</span><span class="s2">${name}</span><span class="s4">: </span><span class="s2">${i.facts.trim()}</span><span class="s4">`</span>);</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>}</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  </span></span><span class="s1">if</span><span class="s5"> (!parts.length) </span><span class="s1">return</span><span class="s5"> </span>"No facts were provided. That usually means the conflict is running on assumptions. Fix that first."<span class="s5">;</span></p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">return</span> parts.join(<span class="s4">"\n\n"</span>);</p>
<p class="p2">}</p>
<p class="p4"><br></p>
<p class="p2"><span class="s1">function</span> scoreBehaviors(beh) {</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">let</span> g=<span class="s3">0</span>,y=<span class="s3">0</span>,r=<span class="s3">0</span>;</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">for</span> (<span class="s1">const</span> b <span class="s1">of</span> BehaviorCatalog.green) <span class="s1">if</span> (beh?.[b.k]) g++;</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">for</span> (<span class="s1">const</span> b <span class="s1">of</span> BehaviorCatalog.yellow) <span class="s1">if</span> (beh?.[b.k]) y++;</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">for</span> (<span class="s1">const</span> b <span class="s1">of</span> BehaviorCatalog.red) <span class="s1">if</span> (beh?.[b.k]) r++;</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">return</span> {g,y,r, <span class="s3">score</span>: (g*<span class="s3">2</span>) - (y*<span class="s3">1</span>) - (r*<span class="s3">3</span>)};</p>
<p class="p2">}</p>
<p class="p4"><br></p>
<p class="p2"><span class="s1">function</span> buildNonNegotiables(intakes) {</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> rules = [];</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">for</span> (<span class="s1">const</span> i <span class="s1">of</span> Object.values(intakes)) {</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span><span class="s1">const</span> b = i.behaviors || {};</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span></span><span class="s1">if</span><span class="s5"> (b.threatLeaving) rules.push(</span>"Stop using threats of leaving/breakup as a weapon. It destroys safety and turns conflict into survival mode."<span class="s5">);</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span></span><span class="s1">if</span><span class="s5"> (b.insults) rules.push(</span>"No insults or name-calling. Attack the issue, not the person."<span class="s5">);</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span></span><span class="s1">if</span><span class="s5"> (b.weaponizedVuln) rules.push(</span>"Do not use trauma/identity/vulnerabilities as ammo. Thatâ€™s cruelty, not communication."<span class="s5">);</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span></span><span class="s1">if</span><span class="s5"> (b.outingThreat) rules.push(</span>"Never threaten outing or exposure. That is abusive."<span class="s5">);</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span></span><span class="s1">if</span><span class="s5"> (b.followedAndCornered) rules.push(</span>"If someone requests space, do not follow/corner them. Agree a return time instead."<span class="s5">);</span></p>
<p class="p2"><span class="Apple-converted-space">Â  </span>}</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">return</span> [...<span class="s1">new</span> Set(rules)];</p>
<p class="p2">}</p>
<p class="p4"><br></p>
<p class="p2"><span class="s1">function</span> generateAnalysis(relationship, users, intakes) {</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> userById = (id) =&gt; users.find(u =&gt; u.id === id);</p>
<p class="p4"><br></p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> perPartner = {};</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">let</span> safetyFindings = [];</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">let</span> toneAll = [];</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">let</span> distortAll = [];</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">for</span> (<span class="s1">const</span> [pid, i] <span class="s1">of</span> Object.entries(intakes)) {</p>
<p class="p3"><span class="s5"><span class="Apple-converted-space">Â  Â  </span></span><span class="s1">const</span><span class="s5"> text = </span><span class="s4">`</span>${i.facts||<span class="s4">""</span>}<span class="s4">\n</span>${i.thoughts||<span class="s4">""</span>}<span class="s4">\n</span>${i.context||<span class="s4">""</span>}<span class="s4">`</span><span class="s5">;</span></p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span><span class="s1">const</span> hits = analyzeText(text);</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>safetyFindings = safetyFindings.concat(hits.safety.map(s =&gt; ({<span class="s3">partnerId</span>: pid, <span class="s3">type</span>:s})));</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>toneAll = toneAll.concat(hits.tone.map(t =&gt; ({<span class="s3">partnerId</span>: pid, <span class="s3">type</span>:t})));</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>distortAll = distortAll.concat(hits.distortions.map(d =&gt; ({<span class="s3">partnerId</span>: pid, ...d})));</p>
<p class="p4"><br></p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span><span class="s1">const</span> s = scoreBehaviors(i.behaviors||{});</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>perPartner[pid] = {</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span><span class="s3">partnerId</span>: pid,</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span><span class="s3">name</span>: userById(pid)?.displayName || <span class="s4">"Partner"</span>,</p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">Â  Â  Â  </span></span>behaviorsScore<span class="s5">: s,</span></p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span><span class="s3">green</span>: BehaviorCatalog.green.filter(b =&gt; i.behaviors?.[b.k]).map(b =&gt; b.t),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span><span class="s3">yellow</span>: BehaviorCatalog.yellow.filter(b =&gt; i.behaviors?.[b.k]).map(b =&gt; b.t),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span><span class="s3">red</span>: BehaviorCatalog.red.filter(b =&gt; i.behaviors?.[b.k]).map(b =&gt; b.t),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span><span class="s3">distortions</span>: hits.distortions,</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span><span class="s3">toneFlags</span>: hits.tone,</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span><span class="s3">fairnessAreas</span>: i.fairnessAreas || [],</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span><span class="s3">feelings</span>: i.emotions || []</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>};</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>}</p>
<p class="p4"><br></p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> theme = summarizeTheme(intakes);</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> nonneg = buildNonNegotiables(intakes);</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> factsMerged = mergeFacts(intakes, userById);</p>
<p class="p4"><br></p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> safetyPivot = safetyFindings.length &gt; <span class="s3">0</span> || nonneg.some(r =&gt; r.toLowerCase().includes(<span class="s4">"abusive"</span>));</p>
<p class="p4"><br></p>
<p class="p5"><span class="s5"><span class="Apple-converted-space">Â  </span></span>// pattern inference (lightweight)</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  </span></span><span class="s1">let</span><span class="s5"> pattern = </span>"Escalation loop: assumptions â†’ emotion spike â†’ reactive behavior â†’ repair attempt (or not) â†’ resentment stored."<span class="s5">;</span></p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> a = Object.values(intakes).map(i =&gt; (i.fairnessAreas||[])).flat();</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  </span></span><span class="s1">if</span><span class="s5"> (a.includes(</span>"Outness/visibility"<span class="s5">)) pattern = </span>"Safety vs visibility tension (common in LGBTQ+ / minority-stress contexts)."<span class="s5">;</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  </span></span><span class="s1">if</span><span class="s5"> (toneAll.some(t =&gt; t.type===</span>"Ultimatum / threat"<span class="s5">) &amp;&amp; toneAll.some(t =&gt; t.type===</span>"Blame language"<span class="s5">)) pattern = </span>"Pursueâ€“withdraw loop: one pushes harder, the other defends/escapes, both feel unsafe."<span class="s5">;</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  </span></span><span class="s1">if</span><span class="s5"> (a.includes(</span>"Privacy/phones"<span class="s5">)) pattern = </span>"Trust-control spiral: reassurance demands â†’ privacy resistance â†’ suspicion â†’ tighter control."<span class="s5">;</span></p>
<p class="p4"><br></p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> coupleSummary = {</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span><span class="s3">headline</span>: theme.headline,</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span><span class="s3">neutralFacts</span>: factsMerged,</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>pattern,</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span><span class="s3">topArea</span>: theme.topArea</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>};</p>
<p class="p4"><br></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">Â  </span></span>return<span class="s5"> {</span></p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span><span class="s3">createdAt</span>: <span class="s1">new</span> Date().toISOString(),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>safetyPivot,</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>safetyFindings,</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>coupleSummary,</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>perPartner,</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>toneAll,</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>distortAll,</p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">Â  Â  </span></span>nonNegotiables<span class="s5">: nonneg,</span></p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span><span class="s3">bluntTruths</span>: buildBluntTruths(perPartner, relationship, theme),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span><span class="s3">repairs</span>: buildRepairScripts(perPartner),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span><span class="s3">boundaryTips</span>: buildBoundaryTips(theme, nonneg),</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>};</p>
<p class="p2">}</p>
<p class="p4"><br></p>
<p class="p2"><span class="s1">function</span> buildBluntTruths(perPartner, relationship, theme) {</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> arr = [];</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> partners = Object.values(perPartner);</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">if</span> (partners.length === <span class="s3">2</span>) {</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span><span class="s1">const</span> [p1,p2] = partners.sort((a,b)=&gt;b.behaviorsScore.score-a.behaviorsScore.score);</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span>arr.push(</span>`Main theme: <span class="s2">${theme.topArea}</span>. If you avoid that topic, you will keep re-fighting the same fight in different costumes.`<span class="s5">);</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span>arr.push(</span>`<span class="s2">${p1.name}</span> is currently showing relatively more repair/fair behavior in this session (not â€œperfectâ€, just less damaging).`<span class="s5">);</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span>arr.push(</span>`<span class="s2">${p2.name}</span> has more escalation signals in this session. That doesnâ€™t mean they're â€œbadâ€. It does mean their current behaviors are making resolution harder.`<span class="s5">);</span></p>
<p class="p2"><span class="Apple-converted-space">Â  </span>} <span class="s1">else</span> {</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span>arr.push(</span>`Main theme: <span class="s2">${theme.topArea}</span>. Focus on the pattern, not the storyline.`<span class="s5">);</span></p>
<p class="p2"><span class="Apple-converted-space">Â  </span>}</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  </span>arr.push(</span>"Facts matter. Assumptions feel real, but they are not evidence."<span class="s5">);</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  </span>arr.push(</span>"Your nervous systems are steering the car. If you donâ€™t slow the body down, the conversation will stay stupid."<span class="s5">);</span></p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">return</span> arr;</p>
<p class="p2">}</p>
<p class="p4"><br></p>
<p class="p2"><span class="s1">function</span> buildRepairScripts(perPartner) {</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> scripts = {};</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">for</span> (<span class="s1">const</span> p <span class="s1">of</span> Object.values(perPartner)) {</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>scripts[p.partnerId] = [</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  Â  </span></span>"What I did (specific behavior): ____"<span class="s5">,</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  Â  </span></span>"Impact on you (how it landed): ____"<span class="s5">,</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  Â  </span></span>"What I understand now (your need / fear): ____"<span class="s5">,</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  Â  </span></span>"What Iâ€™ll do differently next time (one concrete action): ____"<span class="s5">,</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  Â  </span></span>"What Iâ€™m asking from you (one clear request): ____"</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>];</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>}</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">return</span> scripts;</p>
<p class="p2">}</p>
<p class="p4"><br></p>
<p class="p2"><span class="s1">function</span> buildBoundaryTips(theme, nonneg) {</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> tips = [];</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  </span>tips.push(</span>"When you request a break, give a return time. â€˜Iâ€™m overwhelmed, 20 minutes, then we resumeâ€™ beats disappearing."<span class="s5">);</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  </span>tips.push(</span>"One topic at a time. If you bring old issues in mid-argument, youâ€™re not solving anything, youâ€™re winning points."<span class="s5">);</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  </span></span><span class="s1">if</span><span class="s5"> (theme.topArea===</span>"Privacy/phones"<span class="s5">) tips.push(</span>"Agree privacy rules explicitly: whatâ€™s private, whatâ€™s shared, and whatâ€™s reassurance. Guessing creates paranoia."<span class="s5">);</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  </span></span><span class="s1">if</span><span class="s5"> (theme.topArea===</span>"Outness/visibility"<span class="s5">) tips.push(</span>"Safety boundaries and visibility needs are both real. Treat it as a joint problem, not a moral failure."<span class="s5">);</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  </span></span><span class="s1">if</span><span class="s5"> (nonneg.length) tips.push(</span>"Non-negotiables are not suggestions. If you cross them, resolution pauses and safety takes priority."<span class="s5">);</span></p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">return</span> tips;</p>
<p class="p2">}</p>
<p class="p4"><br></p>
<p class="p5">/** -----------------------------</p>
<p class="p5"><span class="Apple-converted-space">Â </span>*<span class="Apple-converted-space">Â  </span>Render helpers</p>
<p class="p5"><span class="Apple-converted-space">Â </span>*<span class="Apple-converted-space">Â  </span>----------------------------- */</p>
<p class="p2"><span class="s1">function</span> setVaultBadge() {</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> pill = $(<span class="s4">"#vaultState"</span>);</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">if</span> (state.locked) {</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>pill.textContent = <span class="s4">"Locked"</span>;</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>pill.className = <span class="s4">"pill"</span>;</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>} <span class="s1">else</span> {</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>pill.textContent = <span class="s4">"Unlocked"</span>;</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>pill.className = <span class="s4">"pill"</span>;</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>}</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>$(<span class="s4">"#lockBtn"</span>).style.display = state.locked ? <span class="s4">"none"</span> : <span class="s4">"inline-flex"</span>;</p>
<p class="p2">}</p>
<p class="p4"><br></p>
<p class="p2"><span class="s1">function</span> navItem(name, view, disabled=<span class="s6">false</span>, badge=<span class="s6">null</span>) {</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  </span></span><span class="s1">const</span><span class="s5"> b = badge ? </span>` &lt;span class="badge <span class="s2">${badge.cls||</span>""<span class="s2">}</span>"&gt;<span class="s2">${badge.txt}</span>&lt;/span&gt;`<span class="s5"> : </span>""<span class="s5">;</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  </span></span><span class="s1">const</span><span class="s5"> btn = el(</span>"button"<span class="s5">, { </span><span class="s3">class</span><span class="s5">:</span>"btn"<span class="s5">, </span><span class="s3">style</span><span class="s5">:</span>"width:100%; justify-content:space-between"<span class="s5">, disabled, </span><span class="s3">onclick</span><span class="s5">:()=&gt;go(view) }, [</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span>el(</span>"span"<span class="s5">, { </span><span class="s3">html</span><span class="s5">: </span>`&lt;span&gt;<span class="s2">${name}</span>&lt;/span&gt;<span class="s2">${b}</span>`<span class="s5"> })</span></p>
<p class="p2"><span class="Apple-converted-space">Â  </span>]);</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">return</span> btn;</p>
<p class="p2">}</p>
<p class="p4"><br></p>
<p class="p2"><span class="s1">function</span> go(view) {</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>state.view = view;</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>render();</p>
<p class="p2">}</p>
<p class="p4"><br></p>
<p class="p2"><span class="s1">function</span> currentRelationship() {</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">return</span> state.vault?.relationships?.find(r =&gt; r.id === state.selected.relationshipId) || <span class="s6">null</span>;</p>
<p class="p2">}</p>
<p class="p4"><br></p>
<p class="p2"><span class="s1">function</span> userById(id){ <span class="s1">return</span> state.vault.users.find(u=&gt;u.id===id);}</p>
<p class="p4"><br></p>
<p class="p5">/** -----------------------------</p>
<p class="p5"><span class="Apple-converted-space">Â </span>*<span class="Apple-converted-space">Â  </span>Main render router</p>
<p class="p5"><span class="Apple-converted-space">Â </span>*<span class="Apple-converted-space">Â  </span>----------------------------- */</p>
<p class="p2"><span class="s1">function</span> render() {</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>setVaultBadge();</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>armAutoLock();</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> nav = $(<span class="s4">"#nav"</span>);</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>nav.innerHTML = <span class="s4">""</span>;</p>
<p class="p4"><br></p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">if</span> (state.locked) {</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span>$(</span>"#navHint"<span class="s5">).textContent = </span>"Unlock to use the app."<span class="s5">;</span></p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>nav.append(navItem(<span class="s4">"Unlock / Create Vault"</span>, <span class="s4">"LOCK"</span>, <span class="s6">false</span>));</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>} <span class="s1">else</span> {</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span>$(</span>"#navHint"<span class="s5">).textContent = </span>"Local encrypted vault. Nothing leaves your device."<span class="s5">;</span></p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>nav.append(</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>navItem(<span class="s4">"Dashboard"</span>, <span class="s4">"DASH"</span>),</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  Â  </span>navItem(</span>"Onboarding (Users)"<span class="s5">, </span>"USERS"<span class="s5">),</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  Â  </span>navItem(</span>"Relationships"<span class="s5">, </span>"RELS"<span class="s5">),</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  Â  </span>navItem(</span>"New Conflict Session"<span class="s5">, </span>"NEW_CONFLICT"<span class="s5">),</span></p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>navItem(<span class="s4">"History"</span>, <span class="s4">"HISTORY"</span>),</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  Â  </span>navItem(</span>"Settings"<span class="s5">, </span>"SETTINGS"<span class="s5">),</span></p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>);</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>}</p>
<p class="p4"><br></p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> main = $(<span class="s4">"#main"</span>);</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>main.innerHTML = <span class="s4">""</span>;</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">if</span> (state.view === <span class="s4">"LOCK"</span>) main.append(renderLock());</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">else</span> <span class="s1">if</span> (state.view === <span class="s4">"DASH"</span>) main.append(renderDash());</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">else</span> <span class="s1">if</span> (state.view === <span class="s4">"USERS"</span>) main.append(renderUsers());</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">else</span> <span class="s1">if</span> (state.view === <span class="s4">"RELS"</span>) main.append(renderRels());</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">else</span> <span class="s1">if</span> (state.view === <span class="s4">"NEW_USER"</span>) main.append(renderNewUser());</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">else</span> <span class="s1">if</span> (state.view === <span class="s4">"NEW_REL"</span>) main.append(renderNewRel());</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">else</span> <span class="s1">if</span> (state.view === <span class="s4">"NEW_CONFLICT"</span>) main.append(renderNewConflict());</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">else</span> <span class="s1">if</span> (state.view === <span class="s4">"INTAKE"</span>) main.append(renderIntake());</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">else</span> <span class="s1">if</span> (state.view === <span class="s4">"REPORT"</span>) main.append(renderReport());</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">else</span> <span class="s1">if</span> (state.view === <span class="s4">"HISTORY"</span>) main.append(renderHistory());</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">else</span> <span class="s1">if</span> (state.view === <span class="s4">"SETTINGS"</span>) main.append(renderSettings());</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">else</span> <span class="s1">if</span> (state.view === <span class="s4">"SAFETY"</span>) main.append(renderSafety());</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">else</span> main.append(el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"muted"</span>, <span class="s3">html</span>:<span class="s4">"Unknown view."</span>}));</p>
<p class="p4"><br></p>
<p class="p2"><span class="Apple-converted-space">Â  </span>applyBranding();</p>
<p class="p2">}</p>
<p class="p4"><br></p>
<p class="p5">/** -----------------------------</p>
<p class="p5"><span class="Apple-converted-space">Â </span>*<span class="Apple-converted-space">Â  </span>Views</p>
<p class="p5"><span class="Apple-converted-space">Â </span>*<span class="Apple-converted-space">Â  </span>----------------------------- */</p>
<p class="p2"><span class="s1">function</span> renderLock() {</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> hasVault = !!localStorage.getItem(STORAGE_KEY);</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> box = el(<span class="s4">"div"</span>,{},[</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span>el(</span>"h2"<span class="s5">,{</span><span class="s3">html</span><span class="s5">:</span>"Vault Lock"<span class="s5">}),</span></p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"muted"</span>, <span class="s3">html</span>:</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  Â  </span></span>"Everything is stored &lt;b&gt;encrypted&lt;/b&gt; on this device. No servers. No accounts. No â€˜oops we trained on your trauma logsâ€™.&lt;br&gt;&lt;br&gt;"<span class="s5"> +</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  Â  </span>(hasVault ? </span>"Enter your vault &lt;b&gt;passphrase&lt;/b&gt; to unlock."<span class="s5"> : </span>"No vault found. Create one."<span class="s5">)</span></p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>}),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"hr"</span>}),</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>]);</p>
<p class="p4"><br></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  </span></span><span class="s1">const</span><span class="s5"> pass = el(</span>"input"<span class="s5">,{</span><span class="s3">type</span><span class="s5">:</span>"password"<span class="s5">, </span><span class="s3">placeholder</span><span class="s5">:</span>"Vault passphrase"<span class="s5">});</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  </span></span><span class="s1">const</span><span class="s5"> pin = el(</span>"input"<span class="s5">,{</span><span class="s3">type</span><span class="s5">:</span>"password"<span class="s5">, </span><span class="s3">placeholder</span><span class="s5">:</span>"Optional: PIN (only works after unlock + enable)"<span class="s5">});</span></p>
<p class="p4"><br></p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> actions = el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"row"</span>},[]);</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">if</span> (hasVault) {</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>actions.append(</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>el(<span class="s4">"button"</span>,{<span class="s3">class</span>:<span class="s4">"btn primary"</span>, <span class="s3">onclick</span>:async()=&gt;{</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  </span><span class="s1">try</span> {</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  Â  </span><span class="s1">await</span> unlockVaultWithPassphrase(pass.value);</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  </span>} <span class="s1">catch</span> (e) {</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  Â  Â  Â  </span>toast(</span>"Unlock failed. Wrong passphrase?"<span class="s5">);</span></p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  </span>}</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>}},[document.createTextNode(<span class="s4">"Unlock"</span>)]),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>el(<span class="s4">"button"</span>,{<span class="s3">class</span>:<span class="s4">"btn"</span>, <span class="s3">onclick</span>:()=&gt;{</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  </span>pass.value = <span class="s4">""</span>;</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  Â  Â  </span>toast(</span>"If you forgot the passphrase, the vault is unrecoverable. Thatâ€™s the point."<span class="s5">);</span></p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>}},[document.createTextNode(<span class="s4">"Forgot?"</span>)]),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>);</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>} <span class="s1">else</span> {</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>actions.append(</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>el(<span class="s4">"button"</span>,{<span class="s3">class</span>:<span class="s4">"btn primary"</span>, <span class="s3">onclick</span>:async()=&gt;{</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  </span><span class="s1">if</span> (pass.value.trim().length &lt; <span class="s3">10</span>) <span class="s1">return</span> toast(<span class="s4">"Use a longer passphrase (10+ chars)."</span>);</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  </span><span class="s1">await</span> createNewVault(pass.value.trim());</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>}},[document.createTextNode(<span class="s4">"Create Vault"</span>)])</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>);</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>}</p>
<p class="p4"><br></p>
<p class="p5"><span class="s5"><span class="Apple-converted-space">Â  </span></span>// Lock/unlock UI</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>box.append(</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span>el(</span>"label"<span class="s5">,{</span><span class="s3">html</span><span class="s5">:</span>"Passphrase"<span class="s5">}),</span></p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>pass,</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span>el(</span>"div"<span class="s5">,{</span><span class="s3">class</span><span class="s5">:</span>"hint"<span class="s5">, </span><span class="s3">html</span><span class="s5">:</span>"Tip: use a sentence. Long beats complex."<span class="s5">}),</span></p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"hr"</span>}),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>actions</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>);</p>
<p class="p4"><br></p>
<p class="p5"><span class="s5"><span class="Apple-converted-space">Â  </span></span>// If vault exists, show harsh reality</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">if</span> (hasVault) {</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>box.append(el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"dangerBox"</span>, <span class="s3">html</span>:</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  Â  </span></span>"&lt;b&gt;Reality:&lt;/b&gt; If you lose the passphrase, nobody (including me) can recover the data. "<span class="s5"> +</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  Â  </span></span>"Thatâ€™s what â€˜privacy-firstâ€™ means when itâ€™s not marketing."</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>}));</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>}</p>
<p class="p4"><br></p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">return</span> box;</p>
<p class="p2">}</p>
<p class="p4"><br></p>
<p class="p2"><span class="s1">function</span> renderDash() {</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> v = state.vault;</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> rel = currentRelationship();</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> kpis = el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"kpi"</span>},[</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"k"</span>},[el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"n"</span>, <span class="s3">html</span>:String(v.users.length)}), el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"l"</span>, <span class="s3">html</span>:<span class="s4">"Users"</span>})]),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"k"</span>},[el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"n"</span>, <span class="s3">html</span>:String(v.relationships.length)}), el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"l"</span>, <span class="s3">html</span>:<span class="s4">"Relationships"</span>})]),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"k"</span>},[el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"n"</span>, <span class="s3">html</span>:String(v.conflicts.length)}), el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"l"</span>, <span class="s3">html</span>:<span class="s4">"Conflict sessions"</span>})]),</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>]);</p>
<p class="p4"><br></p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> c = el(<span class="s4">"div"</span>,{},[</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span>el(</span>"h2"<span class="s5">,{</span><span class="s3">html</span><span class="s5">:</span>"Dashboard"<span class="s5">}),</span></p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"muted"</span>, <span class="s3">html</span>:</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  Â  </span></span>"This MVP is blunt on purpose: it calls out behaviors, distortions, and fairness issues without picking a favorite human."</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>}),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"hr"</span>}),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>kpis,</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"hr"</span>}),</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span>el(</span>"div"<span class="s5">,{</span><span class="s3">class</span><span class="s5">:</span>"goodBox"<span class="s5">, </span><span class="s3">html</span><span class="s5">:</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  Â  </span></span>"&lt;b&gt;How to get value fast:&lt;/b&gt; Create 2 users, create a relationship, run one conflict session. The engine will generate a couple-summary + private feedback."</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>}),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"hr"</span>}),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"row"</span>},[</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  Â  </span>el(</span>"button"<span class="s5">,{</span><span class="s3">class</span><span class="s5">:</span>"btn primary"<span class="s5">, </span><span class="s3">onclick</span><span class="s5">:()=&gt;go(</span>"NEW_CONFLICT"<span class="s5">)},[document.createTextNode(</span>"Start Conflict Session"<span class="s5">)]),</span></p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>el(<span class="s4">"button"</span>,{<span class="s3">class</span>:<span class="s4">"btn"</span>, <span class="s3">onclick</span>:()=&gt;go(<span class="s4">"USERS"</span>)},[document.createTextNode(<span class="s4">"Add / Edit Users"</span>)]),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>el(<span class="s4">"button"</span>,{<span class="s3">class</span>:<span class="s4">"btn"</span>, <span class="s3">onclick</span>:()=&gt;go(<span class="s4">"RELS"</span>)},[document.createTextNode(<span class="s4">"Relationships"</span>)])</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>])</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>]);</p>
<p class="p4"><br></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">Â  </span></span>return<span class="s5"> c;</span></p>
<p class="p2">}</p>
<p class="p4"><br></p>
<p class="p2"><span class="s1">function</span> renderUsers() {</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> v = state.vault;</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> box = el(<span class="s4">"div"</span>,{},[</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>el(<span class="s4">"h2"</span>,{<span class="s3">html</span>:<span class="s4">"Users"</span>}),</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span>el(</span>"div"<span class="s5">,{</span><span class="s3">class</span><span class="s5">:</span>"muted"<span class="s5">, </span><span class="s3">html</span><span class="s5">:</span>"Add each partner here. You can store pronouns, culture, outness stressors, triggers, and conflict style."<span class="s5">}),</span></p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"hr"</span>}),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"row"</span>},[</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>el(<span class="s4">"button"</span>,{<span class="s3">class</span>:<span class="s4">"btn primary"</span>, <span class="s3">onclick</span>:()=&gt;go(<span class="s4">"NEW_USER"</span>)},[document.createTextNode(<span class="s4">"Add User"</span>)]),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>]),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"hr"</span>}),</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>]);</p>
<p class="p4"><br></p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> list = el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"list"</span>},[]);</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">for</span> (<span class="s1">const</span> u <span class="s1">of</span> v.users) {</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>list.append(el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"item"</span>},[</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>el(<span class="s4">"div"</span>,{},[</p>
<p class="p3"><span class="s5"><span class="Apple-converted-space">Â  Â  Â  Â  </span>el(</span><span class="s4">"div"</span><span class="s5">,{</span><span class="s3">html</span><span class="s5">:</span><span class="s4">`&lt;b&gt;</span>${escapeHtml(u.displayName||<span class="s4">"(no name)"</span>)}<span class="s4">&lt;/b&gt; &lt;span class="small"&gt;</span>${escapeHtml(u.pronouns||<span class="s4">""</span>)}<span class="s4">&lt;/span&gt;`</span><span class="s5">}),</span></p>
<p class="p3"><span class="s5"><span class="Apple-converted-space">Â  Â  Â  Â  </span>el(</span><span class="s4">"div"</span><span class="s5">,{</span><span class="s3">class</span><span class="s5">:</span><span class="s4">"small"</span><span class="s5">, </span><span class="s3">html</span><span class="s5">:</span><span class="s4">`</span>${escapeHtml(u.genderIdentity||<span class="s4">""</span>)}<span class="s4"> Â· </span>${escapeHtml(u.sexualOrientation||<span class="s4">""</span>)}<span class="s4"> Â· </span>${escapeHtml((u.languages||[]).join(<span class="s4">", "</span>))}<span class="s4">`</span><span class="s5">})</span></p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>]),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"inline"</span>},[</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  </span>el(<span class="s4">"button"</span>,{<span class="s3">class</span>:<span class="s4">"btn"</span>, <span class="s3">onclick</span>:()=&gt;editUser(u.id)},[document.createTextNode(<span class="s4">"Edit"</span>)]),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  </span>el(<span class="s4">"button"</span>,{<span class="s3">class</span>:<span class="s4">"btn danger"</span>, <span class="s3">onclick</span>:()=&gt;deleteUser(u.id)},[document.createTextNode(<span class="s4">"Delete"</span>)]),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>])</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>]));</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>}</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  </span></span><span class="s1">if</span><span class="s5"> (!v.users.length) list.append(el(</span>"div"<span class="s5">,{</span><span class="s3">class</span><span class="s5">:</span>"muted"<span class="s5">, </span><span class="s3">html</span><span class="s5">:</span>"No users yet. Add two users to start."<span class="s5">}));</span></p>
<p class="p4"><br></p>
<p class="p2"><span class="Apple-converted-space">Â  </span>box.append(list);</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">return</span> box;</p>
<p class="p2">}</p>
<p class="p4"><br></p>
<p class="p2"><span class="s1">function</span> renderNewUser() {</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> v = state.vault;</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> editingId = state._editingUserId || <span class="s6">null</span>;</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> existing = editingId ? v.users.find(u=&gt;u.id===editingId) : <span class="s6">null</span>;</p>
<p class="p4"><br></p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> box = el(<span class="s4">"div"</span>,{},[</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>el(<span class="s4">"h2"</span>,{<span class="s3">html</span>: existing ? <span class="s4">"Edit User"</span> : <span class="s4">"New User"</span>}),</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span>el(</span>"div"<span class="s5">,{</span><span class="s3">class</span><span class="s5">:</span>"muted"<span class="s5">, </span><span class="s3">html</span><span class="s5">:</span>"Keep it lightweight. This is not diagnosing anyone, itâ€™s building context so conflicts get interpreted realistically."<span class="s5">}),</span></p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"hr"</span>}),</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>]);</p>
<p class="p4"><br></p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> f = {</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span><span class="s3">displayName</span>: input(existing?.displayName || <span class="s4">""</span>),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span><span class="s3">pronouns</span>: input(existing?.pronouns || <span class="s4">""</span>),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span><span class="s3">genderIdentity</span>: input(existing?.genderIdentity || <span class="s4">""</span>),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span><span class="s3">sexualOrientation</span>: input(existing?.sexualOrientation || <span class="s4">""</span>),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span><span class="s3">age</span>: input(existing?.age || <span class="s4">""</span>),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span><span class="s3">location</span>: input(existing?.location || <span class="s4">""</span>),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span><span class="s3">culture</span>: input(existing?.cultureBackground || <span class="s4">""</span>),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span><span class="s3">religion</span>: input(existing?.religionSpirituality || <span class="s4">""</span>),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span><span class="s3">languages</span>: input((existing?.languages||[]).join(<span class="s4">", "</span>)),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span><span class="s3">attachment</span>: select([<span class="s4">"secure"</span>,<span class="s4">"anxious"</span>,<span class="s4">"avoidant"</span>,<span class="s4">"disorganized"</span>], existing?.attachmentStyle || <span class="s4">"secure"</span>),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span><span class="s3">conflictStyle</span>: select([<span class="s4">"fight"</span>,<span class="s4">"flight"</span>,<span class="s4">"freeze"</span>,<span class="s4">"fawn"</span>], existing?.conflictStyle || <span class="s4">"fight"</span>),</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span></span><span class="s3">outness</span><span class="s5">: select([</span>"not out"<span class="s5">,</span>"partially out"<span class="s5">,</span>"out to friends"<span class="s5">,</span>"out to family"<span class="s5">,</span>"out at work"<span class="s5">,</span>"fully out"<span class="s5">], existing?.outnessLevel || </span>"partially out"<span class="s5">),</span></p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span><span class="s3">stressors</span>: textarea(existing?.currentStressors || <span class="s4">""</span>),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span><span class="s3">triggers</span>: textarea((existing?.triggers||[]).join(<span class="s4">"\n"</span>)),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span><span class="s3">coreBeliefs</span>: textarea((existing?.coreBeliefs||[]).join(<span class="s4">"\n"</span>)),</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>};</p>
<p class="p4"><br></p>
<p class="p2"><span class="Apple-converted-space">Â  </span>box.append(</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>formRow(<span class="s4">"Display name"</span>, f.displayName),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>formRow(<span class="s4">"Pronouns"</span>, f.pronouns),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"split"</span>},[</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>formRow(<span class="s4">"Gender identity"</span>, f.genderIdentity),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>formRow(<span class="s4">"Sexual orientation"</span>, f.sexualOrientation),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>]),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"split"</span>},[</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>formRow(<span class="s4">"Age (optional)"</span>, f.age),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>formRow(<span class="s4">"Location (optional)"</span>, f.location),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>]),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>formRow(<span class="s4">"Cultural background"</span>, f.culture),</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span>formRow(</span>"Religion / spirituality (optional)"<span class="s5">, f.religion),</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span>formRow(</span>"Languages (comma separated)"<span class="s5">, f.languages),</span></p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"split"</span>},[</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  Â  </span>formRow(</span>"Attachment style (light indicator)"<span class="s5">, f.attachment),</span></p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>formRow(<span class="s4">"Conflict style"</span>, f.conflictStyle),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>]),</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span>formRow(</span>"Outness level (safety/visibility context)"<span class="s5">, f.outness),</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span>formRow(</span>"Current stressors (work, money, family, health)"<span class="s5">, f.stressors),</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span>formRow(</span>"Trigger library (one per line)"<span class="s5">, f.triggers),</span></p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>formRow(<span class="s4">"Core beliefs (one per line)"</span>, f.coreBeliefs),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"hr"</span>}),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"row"</span>},[</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>el(<span class="s4">"button"</span>,{<span class="s3">class</span>:<span class="s4">"btn primary"</span>, <span class="s3">onclick</span>:async()=&gt;{</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  </span><span class="s1">const</span> u = {</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  Â  </span><span class="s3">id</span>: existing?.id || uid(<span class="s4">"user"</span>),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  Â  </span><span class="s3">displayName</span>: f.displayName.value.trim() || <span class="s4">"Unnamed"</span>,</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  Â  </span><span class="s3">pronouns</span>: f.pronouns.value.trim(),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  Â  </span><span class="s3">genderIdentity</span>: f.genderIdentity.value.trim(),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  Â  </span><span class="s3">sexualOrientation</span>: f.sexualOrientation.value.trim(),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  Â  </span><span class="s3">age</span>: f.age.value.trim(),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  Â  </span><span class="s3">location</span>: f.location.value.trim(),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  Â  </span><span class="s3">cultureBackground</span>: f.culture.value.trim(),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  Â  </span><span class="s3">religionSpirituality</span>: f.religion.value.trim(),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  Â  </span><span class="s3">languages</span>: f.languages.value.split(<span class="s4">","</span>).map(s=&gt;s.trim()).filter(Boolean),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  Â  </span><span class="s3">attachmentStyle</span>: f.attachment.value,</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  Â  </span><span class="s3">conflictStyle</span>: f.conflictStyle.value,</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  Â  </span><span class="s3">outnessLevel</span>: f.outness.value,</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  Â  </span><span class="s3">currentStressors</span>: f.stressors.value.trim(),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  Â  </span><span class="s3">triggers</span>: f.triggers.value.split(<span class="s4">"\n"</span>).map(s=&gt;s.trim()).filter(Boolean),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  Â  </span><span class="s3">coreBeliefs</span>: f.coreBeliefs.value.split(<span class="s4">"\n"</span>).map(s=&gt;s.trim()).filter(Boolean),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  Â  </span><span class="s3">createdAt</span>: existing?.createdAt || <span class="s1">new</span> Date().toISOString()</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  </span>};</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  </span><span class="s1">if</span> (existing) {</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  Â  </span><span class="s1">const</span> idx = v.users.findIndex(x=&gt;x.id===existing.id);</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  Â  </span>v.users[idx] = u;</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  </span>} <span class="s1">else</span> {</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  Â  </span>v.users.push(u);</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  </span>}</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  </span>state._editingUserId = <span class="s6">null</span>;</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  </span><span class="s1">await</span> saveVault();</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  </span>go(<span class="s4">"USERS"</span>);</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  </span>toast(<span class="s4">"Saved."</span>);</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>}},[document.createTextNode(<span class="s4">"Save User"</span>)]),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>el(<span class="s4">"button"</span>,{<span class="s3">class</span>:<span class="s4">"btn"</span>, <span class="s3">onclick</span>:()=&gt;{</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  </span>state._editingUserId = <span class="s6">null</span>;</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  </span>go(<span class="s4">"USERS"</span>);</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>}},[document.createTextNode(<span class="s4">"Cancel"</span>)]),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>])</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>);</p>
<p class="p4"><br></p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">return</span> box;</p>
<p class="p2">}</p>
<p class="p4"><br></p>
<p class="p2"><span class="s1">function</span> renderRels() {</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> v = state.vault;</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> box = el(<span class="s4">"div"</span>,{},[</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span>el(</span>"h2"<span class="s5">,{</span><span class="s3">html</span><span class="s5">:</span>"Relationships"<span class="s5">}),</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span>el(</span>"div"<span class="s5">,{</span><span class="s3">class</span><span class="s5">:</span>"muted"<span class="s5">, </span><span class="s3">html</span><span class="s5">:</span>"Create a relationship, attach partners, track rules + agreements, then run conflict sessions against it."<span class="s5">}),</span></p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"hr"</span>}),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"row"</span>},[</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>el(<span class="s4">"button"</span>,{<span class="s3">class</span>:<span class="s4">"btn primary"</span>, <span class="s3">onclick</span>:()=&gt;go(<span class="s4">"NEW_REL"</span>)},[document.createTextNode(<span class="s4">"Create Relationship"</span>)]),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>]),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"hr"</span>}),</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>]);</p>
<p class="p4"><br></p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> list = el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"list"</span>},[]);</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">for</span> (<span class="s1">const</span> r <span class="s1">of</span> v.relationships) {</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span><span class="s1">const</span> members = r.memberIds.map(id=&gt;userById(id)?.displayName||<span class="s4">"Unknown"</span>).join(<span class="s4">" + "</span>);</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span><span class="s1">const</span> isSelected = state.selected.relationshipId === r.id;</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>list.append(el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"item"</span>},[</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>el(<span class="s4">"div"</span>,{},[</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  Â  Â  </span>el(</span>"div"<span class="s5">,{</span><span class="s3">html</span><span class="s5">:</span>`&lt;b&gt;<span class="s2">${escapeHtml(r.name||</span>"Relationship"<span class="s2">)}</span>&lt;/b&gt; <span class="s2">${isSelected?</span>'&lt;span class="badge bG"&gt;Selected&lt;/span&gt;'<span class="s2">:</span>''<span class="s2">}</span>`<span class="s5">}),</span></p>
<p class="p3"><span class="s5"><span class="Apple-converted-space">Â  Â  Â  Â  </span>el(</span><span class="s4">"div"</span><span class="s5">,{</span><span class="s3">class</span><span class="s5">:</span><span class="s4">"small"</span><span class="s5">, </span><span class="s3">html</span><span class="s5">:</span><span class="s4">`</span>${escapeHtml(members)}<span class="s4"> Â· </span>${escapeHtml(r.structure||<span class="s4">""</span>)}<span class="s4"> Â· </span>${escapeHtml(r.status||<span class="s4">""</span>)}<span class="s4">`</span><span class="s5">})</span></p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>]),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"inline"</span>},[</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  </span>el(<span class="s4">"button"</span>,{<span class="s3">class</span>:<span class="s4">"btn good"</span>, <span class="s3">onclick</span>:()=&gt;{ state.selected.relationshipId = r.id; saveVault(); render(); toast(<span class="s4">"Relationship selected."</span>); }},[document.createTextNode(<span class="s4">"Select"</span>)]),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  </span>el(<span class="s4">"button"</span>,{<span class="s3">class</span>:<span class="s4">"btn"</span>, <span class="s3">onclick</span>:()=&gt;editRel(r.id)},[document.createTextNode(<span class="s4">"Edit"</span>)]),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  </span>el(<span class="s4">"button"</span>,{<span class="s3">class</span>:<span class="s4">"btn danger"</span>, <span class="s3">onclick</span>:()=&gt;deleteRel(r.id)},[document.createTextNode(<span class="s4">"Delete"</span>)]),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>])</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>]));</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>}</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  </span></span><span class="s1">if</span><span class="s5"> (!v.relationships.length) list.append(el(</span>"div"<span class="s5">,{</span><span class="s3">class</span><span class="s5">:</span>"muted"<span class="s5">, </span><span class="s3">html</span><span class="s5">:</span>"No relationships yet. Create one after adding users."<span class="s5">}));</span></p>
<p class="p4"><br></p>
<p class="p2"><span class="Apple-converted-space">Â  </span>box.append(list);</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">return</span> box;</p>
<p class="p2">}</p>
<p class="p4"><br></p>
<p class="p2"><span class="s1">function</span> renderNewRel() {</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> v = state.vault;</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> editingId = state._editingRelId || <span class="s6">null</span>;</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> existing = editingId ? v.relationships.find(r=&gt;r.id===editingId) : <span class="s6">null</span>;</p>
<p class="p4"><br></p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> box = el(<span class="s4">"div"</span>,{},[</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span>el(</span>"h2"<span class="s5">,{</span><span class="s3">html</span><span class="s5">: existing ? </span>"Edit Relationship"<span class="s5"> : </span>"New Relationship"<span class="s5">}),</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span>el(</span>"div"<span class="s5">,{</span><span class="s3">class</span><span class="s5">:</span>"muted"<span class="s5">, </span><span class="s3">html</span><span class="s5">:</span>"MVP assumes 2 partners. Poly/ENM expansion later is straightforward structurally."<span class="s5">}),</span></p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"hr"</span>}),</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>]);</p>
<p class="p4"><br></p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">if</span> (v.users.length &lt; <span class="s3">2</span>) {</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span>box.append(el(</span>"div"<span class="s5">,{</span><span class="s3">class</span><span class="s5">:</span>"warnBox"<span class="s5">, </span><span class="s3">html</span><span class="s5">:</span>"You need at least &lt;b&gt;2 users&lt;/b&gt; first. Go create them."<span class="s5">}));</span></p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>box.append(el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"hr"</span>}));</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>}</p>
<p class="p4"><br></p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> name = input(existing?.name || <span class="s4">""</span>);</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> structure = select([<span class="s4">"monogamous"</span>,<span class="s4">"open"</span>,<span class="s4">"ENM"</span>,<span class="s4">"poly (later)"</span>], existing?.structure || <span class="s4">"monogamous"</span>);</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  </span></span><span class="s1">const</span><span class="s5"> status = select([</span>"dating"<span class="s5">,</span>"partnered"<span class="s5">,</span>"married"<span class="s5">,</span>"long-distance"<span class="s5">,</span>"separating"<span class="s5">], existing?.status || </span>"dating"<span class="s5">);</span></p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> duration = input(existing?.durationMonths || <span class="s4">""</span>);</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  </span></span><span class="s1">const</span><span class="s5"> outness = select([</span>"not out"<span class="s5">,</span>"partially out"<span class="s5">,</span>"mixed (different levels)"<span class="s5">,</span>"fully out"<span class="s5">], existing?.outnessLevel || </span>"partially out"<span class="s5">);</span></p>
<p class="p4"><br></p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> memberA = select(v.users.map(u=&gt;u.id), existing?.memberIds?.[<span class="s3">0</span>] || v.users[<span class="s3">0</span>]?.id || <span class="s4">""</span>);</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> memberB = select(v.users.map(u=&gt;u.id), existing?.memberIds?.[<span class="s3">1</span>] || v.users[<span class="s3">1</span>]?.id || <span class="s4">""</span>);</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>memberA._render = () =&gt; v.users.map(u=&gt;({<span class="s3">value</span>:u.id,<span class="s3">label</span>:u.displayName}));</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>memberB._render = () =&gt; v.users.map(u=&gt;({<span class="s3">value</span>:u.id,<span class="s3">label</span>:u.displayName}));</p>
<p class="p4"><br></p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> rules = textarea((existing?.rules||[]).join(<span class="s4">"\n"</span>));</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> agreements = textarea((existing?.agreements||[]).join(<span class="s4">"\n"</span>));</p>
<p class="p4"><br></p>
<p class="p2"><span class="Apple-converted-space">Â  </span>box.append(</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>formRow(<span class="s4">"Relationship name"</span>, name),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"split"</span>},[</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>formRow(<span class="s4">"Structure"</span>, structure),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>formRow(<span class="s4">"Status"</span>, status),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>]),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"split"</span>},[</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>formRow(<span class="s4">"Duration (months)"</span>, duration),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>formRow(<span class="s4">"Outness level"</span>, outness),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>]),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"split"</span>},[</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>formRow(<span class="s4">"Partner A"</span>, memberA, {<span class="s3">labels</span>: memberA._render()}),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>formRow(<span class="s4">"Partner B"</span>, memberB, {<span class="s3">labels</span>: memberB._render()}),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>]),</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span>formRow(</span>"Relationship Rules (one per line)"<span class="s5">, rules),</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span>formRow(</span>"Micro-agreements (one per line)"<span class="s5">, agreements),</span></p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"hr"</span>}),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"row"</span>},[</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>el(<span class="s4">"button"</span>,{<span class="s3">class</span>:<span class="s4">"btn primary"</span>, <span class="s3">onclick</span>:async()=&gt;{</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  </span><span class="s1">const</span> a = memberA.value, b = memberB.value;</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  </span><span class="s1">if</span> (!a || !b || a===b) <span class="s1">return</span> toast(<span class="s4">"Select two different partners."</span>);</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  </span><span class="s1">const</span> rel = {</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  Â  </span><span class="s3">id</span>: existing?.id || uid(<span class="s4">"rel"</span>),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  Â  </span><span class="s3">name</span>: name.value.trim() || <span class="s4">"Relationship"</span>,</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  Â  </span><span class="s3">structure</span>: structure.value,</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  Â  </span><span class="s3">status</span>: status.value,</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  Â  </span><span class="s3">durationMonths</span>: duration.value.trim(),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  Â  </span><span class="s3">outnessLevel</span>: outness.value,</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  Â  </span><span class="s3">memberIds</span>: [a,b],</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  Â  </span><span class="s3">rules</span>: rules.value.split(<span class="s4">"\n"</span>).map(s=&gt;s.trim()).filter(Boolean),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  Â  </span><span class="s3">agreements</span>: agreements.value.split(<span class="s4">"\n"</span>).map(s=&gt;s.trim()).filter(Boolean),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  Â  </span><span class="s3">createdAt</span>: existing?.createdAt || <span class="s1">new</span> Date().toISOString()</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  </span>};</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  </span><span class="s1">if</span> (existing) {</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  Â  </span><span class="s1">const</span> idx = v.relationships.findIndex(x=&gt;x.id===existing.id);</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  Â  </span>v.relationships[idx] = rel;</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  </span>} <span class="s1">else</span> {</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  Â  </span>v.relationships.push(rel);</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  Â  </span>state.selected.relationshipId = rel.id;</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  </span>}</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  </span>state._editingRelId = <span class="s6">null</span>;</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  </span><span class="s1">await</span> saveVault();</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  </span>go(<span class="s4">"RELS"</span>);</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  Â  Â  </span>toast(</span>"Saved relationship."<span class="s5">);</span></p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>}},[document.createTextNode(<span class="s4">"Save Relationship"</span>)]),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>el(<span class="s4">"button"</span>,{<span class="s3">class</span>:<span class="s4">"btn"</span>, <span class="s3">onclick</span>:()=&gt;{</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  </span>state._editingRelId = <span class="s6">null</span>;</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  </span>go(<span class="s4">"RELS"</span>);</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>}},[document.createTextNode(<span class="s4">"Cancel"</span>)]),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>])</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>);</p>
<p class="p4"><br></p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">return</span> box;</p>
<p class="p2">}</p>
<p class="p4"><br></p>
<p class="p2"><span class="s1">function</span> renderNewConflict() {</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> v = state.vault;</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> rel = currentRelationship();</p>
<p class="p4"><br></p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> box = el(<span class="s4">"div"</span>,{},[</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span>el(</span>"h2"<span class="s5">,{</span><span class="s3">html</span><span class="s5">:</span>"New Conflict Session"<span class="s5">}),</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span>el(</span>"div"<span class="s5">,{</span><span class="s3">class</span><span class="s5">:</span>"muted"<span class="s5">, </span><span class="s3">html</span><span class="s5">:</span>"Each partner completes a private intake. The app generates a couple summary + private feedback. No one sees raw private text unless you choose to share it."<span class="s5">}),</span></p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"hr"</span>}),</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>]);</p>
<p class="p4"><br></p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">if</span> (!rel) {</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span>box.append(el(</span>"div"<span class="s5">,{</span><span class="s3">class</span><span class="s5">:</span>"warnBox"<span class="s5">, </span><span class="s3">html</span><span class="s5">:</span>"Select a relationship first (Relationships â†’ Select)."<span class="s5">}));</span></p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span><span class="s1">return</span> box;</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>}</p>
<p class="p4"><br></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  </span></span><span class="s1">const</span><span class="s5"> mode = select([</span>"asynchronous"<span class="s5">,</span>"live (same device sequential)"<span class="s5">], </span>"asynchronous"<span class="s5">);</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  </span></span><span class="s1">const</span><span class="s5"> outcome = select([</span>"understanding"<span class="s5">,</span>"compromise"<span class="s5">,</span>"clarity"<span class="s5">,</span>"separation"<span class="s5">], </span>"understanding"<span class="s5">);</span></p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> willing = select([<span class="s4">"yes"</span>,<span class="s4">"not sure"</span>,<span class="s4">"no"</span>], <span class="s4">"yes"</span>);</p>
<p class="p4"><br></p>
<p class="p2"><span class="Apple-converted-space">Â  </span>box.append(</p>
<p class="p3"><span class="s5"><span class="Apple-converted-space">Â  Â  </span>el(</span><span class="s4">"div"</span><span class="s5">,{</span><span class="s3">class</span><span class="s5">:</span><span class="s4">"goodBox"</span><span class="s5">, </span><span class="s3">html</span><span class="s5">:</span><span class="s4">`&lt;b&gt;Selected:&lt;/b&gt; </span>${escapeHtml(rel.name)}<span class="s4"> Â· </span>${escapeHtml(rel.structure)}<span class="s4"> Â· </span>${escapeHtml(rel.status)}<span class="s4">`</span><span class="s5">}),</span></p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"hr"</span>}),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"split"</span>},[</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>formRow(<span class="s4">"Mode"</span>, mode),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>formRow(<span class="s4">"Desired outcome"</span>, outcome),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>]),</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span>formRow(</span>"Are you both willing to work on this?"<span class="s5">, willing),</span></p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"hr"</span>}),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>el(<span class="s4">"button"</span>,{<span class="s3">class</span>:<span class="s4">"btn primary"</span>, <span class="s3">onclick</span>:async()=&gt;{</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span><span class="s1">const</span> conflict = {</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  </span><span class="s3">id</span>: uid(<span class="s4">"conf"</span>),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  </span><span class="s3">relationshipId</span>: rel.id,</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  </span><span class="s3">createdAt</span>: <span class="s1">new</span> Date().toISOString(),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  </span><span class="s3">mode</span>: mode.value,</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  </span><span class="s3">outcome</span>: outcome.value,</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  </span><span class="s3">willing</span>: willing.value,</p>
<p class="p5"><span class="s5"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s3">partnerIntakes</span><span class="s5">: {}, </span>// partnerId -&gt; intake</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  </span><span class="s3">analysis</span>: <span class="s6">null</span></p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>};</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>v.conflicts.push(conflict);</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>state.selected.conflictId = conflict.id;</p>
<p class="p5"><span class="s5"><span class="Apple-converted-space">Â  Â  Â  </span></span>// start intake with first partner</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>state.selected.activePartnerId = rel.memberIds[<span class="s3">0</span>];</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span><span class="s1">await</span> saveVault();</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>state.view = <span class="s4">"INTAKE"</span>;</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>render();</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>}},[document.createTextNode(<span class="s4">"Start Intake (Partner A)"</span>)])</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>);</p>
<p class="p4"><br></p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">return</span> box;</p>
<p class="p2">}</p>
<p class="p4"><br></p>
<p class="p2"><span class="s1">function</span> renderIntake() {</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> v = state.vault;</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> rel = currentRelationship();</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> conflict = v.conflicts.find(c=&gt;c.id===state.selected.conflictId);</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> partnerId = state.selected.activePartnerId;</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> partner = userById(partnerId);</p>
<p class="p4"><br></p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> box = el(<span class="s4">"div"</span>,{},[</p>
<p class="p3"><span class="s5"><span class="Apple-converted-space">Â  Â  </span>el(</span><span class="s4">"h2"</span><span class="s5">,{</span><span class="s3">html</span><span class="s5">:</span><span class="s4">`Private Intake: </span>${escapeHtml(partner?.displayName||<span class="s4">"Partner"</span>)}<span class="s4">`</span><span class="s5">}),</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span>el(</span>"div"<span class="s5">,{</span><span class="s3">class</span><span class="s5">:</span>"muted"<span class="s5">, </span><span class="s3">html</span><span class="s5">:</span>"Be factual first. Opinions come later. This reduces mind-reading and nonsense."<span class="s5">}),</span></p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"hr"</span>}),</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>]);</p>
<p class="p4"><br></p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">if</span> (!rel || !conflict) {</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span>box.append(el(</span>"div"<span class="s5">,{</span><span class="s3">class</span><span class="s5">:</span>"warnBox"<span class="s5">, </span><span class="s3">html</span><span class="s5">:</span>"Missing relationship/conflict. Go back to New Conflict Session."<span class="s5">}));</span></p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span><span class="s1">return</span> box;</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>}</p>
<p class="p4"><br></p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> existing = conflict.partnerIntakes[partnerId] || {};</p>
<p class="p4"><br></p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> facts = textarea(existing.facts || <span class="s4">""</span>);</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> thoughts = textarea(existing.thoughts || <span class="s4">""</span>);</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> emotions = textarea((existing.emotions||[]).map(e=&gt;<span class="s4">`</span><span class="s2">${e.name}</span><span class="s4">:</span><span class="s2">${e.intensity}</span><span class="s4">`</span>).join(<span class="s4">"\n"</span>));</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> behaviors = existing.behaviors || {};</p>
<p class="p4"><br></p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> fairness = multiSelect(FairnessAreas, existing.fairnessAreas || []);</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> context = textarea(existing.context || <span class="s4">""</span>);</p>
<p class="p4"><br></p>
<p class="p5"><span class="s5"><span class="Apple-converted-space">Â  </span></span>// behavior checkboxes</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> behBox = el(<span class="s4">"div"</span>,{},[</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span>el(</span>"div"<span class="s5">,{</span><span class="s3">class</span><span class="s5">:</span>"muted"<span class="s5">, </span><span class="s3">html</span><span class="s5">:</span>"Behaviors (check what applies in this conflict):"<span class="s5">}),</span></p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"hr"</span>}),</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span>el(</span>"div"<span class="s5">,{</span><span class="s3">class</span><span class="s5">:</span>"muted"<span class="s5">, </span><span class="s3">html</span><span class="s5">:</span>"&lt;b&gt;Green&lt;/b&gt; (helps resolution)"<span class="s5">}),</span></p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>renderChecks(BehaviorCatalog.green, behaviors),</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span>el(</span>"div"<span class="s5">,{</span><span class="s3">class</span><span class="s5">:</span>"muted"<span class="s5">, </span><span class="s3">html</span><span class="s5">:</span>"&lt;b&gt;Yellow&lt;/b&gt; (repairable, but not great)"<span class="s5">}),</span></p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>renderChecks(BehaviorCatalog.yellow, behaviors),</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span>el(</span>"div"<span class="s5">,{</span><span class="s3">class</span><span class="s5">:</span>"muted"<span class="s5">, </span><span class="s3">html</span><span class="s5">:</span>"&lt;b&gt;Red&lt;/b&gt; (non-negotiable to stop)"<span class="s5">}),</span></p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>renderChecks(BehaviorCatalog.red, behaviors),</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>]);</p>
<p class="p4"><br></p>
<p class="p5"><span class="s5"><span class="Apple-converted-space">Â  </span></span>// speech-to-text for facts/thoughts/context</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> sttRow = el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"row"</span>},[</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>el(<span class="s4">"button"</span>,{<span class="s3">class</span>:<span class="s4">"btn"</span>, <span class="s3">onclick</span>:()=&gt;startSTT(facts)},[document.createTextNode(<span class="s4">"ðŸŽ™ï¸ Speak â†’ Facts"</span>)]),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>el(<span class="s4">"button"</span>,{<span class="s3">class</span>:<span class="s4">"btn"</span>, <span class="s3">onclick</span>:()=&gt;startSTT(thoughts)},[document.createTextNode(<span class="s4">"ðŸŽ™ï¸ Speak â†’ Thoughts"</span>)]),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>el(<span class="s4">"button"</span>,{<span class="s3">class</span>:<span class="s4">"btn"</span>, <span class="s3">onclick</span>:()=&gt;startSTT(context)},[document.createTextNode(<span class="s4">"ðŸŽ™ï¸ Speak â†’ Context"</span>)]),</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span>el(</span>"span"<span class="s5">,{</span><span class="s3">class</span><span class="s5">:</span>"muted"<span class="s5">, </span><span class="s3">html</span><span class="s5">:</span>"(Speech-to-text only works if your browser supports it.)"<span class="s5">})</span></p>
<p class="p2"><span class="Apple-converted-space">Â  </span>]);</p>
<p class="p4"><br></p>
<p class="p2"><span class="Apple-converted-space">Â  </span>box.append(</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span>formRow(</span>"1) Facts (what happened, no opinions)"<span class="s5">, facts),</span></p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>sttRow,</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span>formRow(</span>"2) Interpretations / thoughts (what you assumed it meant)"<span class="s5">, thoughts),</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span>formRow(</span>"3) Emotions (one per line like: anger:7)"<span class="s5">, emotions),</span></p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>behBox,</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"hr"</span>}),</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span>el(</span>"div"<span class="s5">,{</span><span class="s3">class</span><span class="s5">:</span>"muted"<span class="s5">, </span><span class="s3">html</span><span class="s5">:</span>"5) Fairness perception areas (select what felt unfair/unclear):"<span class="s5">}),</span></p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>fairness.node,</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span>formRow(</span>"6) Context (stress, trauma activation, culture, safety, exhaustion)"<span class="s5">, context),</span></p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"hr"</span>}),</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>);</p>
<p class="p4"><br></p>
<p class="p5"><span class="s5"><span class="Apple-converted-space">Â  </span></span>// buttons: save intake, next partner / analyze</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> hasA = !!conflict.partnerIntakes[rel.memberIds[<span class="s3">0</span>]];</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> hasB = !!conflict.partnerIntakes[rel.memberIds[<span class="s3">1</span>]];</p>
<p class="p4"><br></p>
<p class="p2"><span class="Apple-converted-space">Â  </span>box.append(el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"row"</span>},[</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>el(<span class="s4">"button"</span>,{<span class="s3">class</span>:<span class="s4">"btn primary"</span>, <span class="s3">onclick</span>:async()=&gt;{</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span><span class="s1">const</span> intake = {</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  </span><span class="s3">facts</span>: facts.value.trim(),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  </span><span class="s3">thoughts</span>: thoughts.value.trim(),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  </span><span class="s3">emotions</span>: parseEmotions(emotions.value),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  </span><span class="s3">behaviors</span>: readBehaviors(behBox),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  </span><span class="s3">fairnessAreas</span>: fairness.get(),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  </span><span class="s3">context</span>: context.value.trim()</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>};</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>conflict.partnerIntakes[partnerId] = intake;</p>
<p class="p4"><br></p>
<p class="p5"><span class="s5"><span class="Apple-converted-space">Â  Â  Â  </span></span>// Safety screening immediately</p>
<p class="p3"><span class="s5"><span class="Apple-converted-space">Â  Â  Â  </span></span><span class="s1">const</span><span class="s5"> text = </span><span class="s4">`</span>${intake.facts}<span class="s4">\n</span>${intake.thoughts}<span class="s4">\n</span>${intake.context}<span class="s4">`</span><span class="s5">;</span></p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span><span class="s1">const</span> hits = analyzeText(text);</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span><span class="s1">if</span> (hits.safety.length) {</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  </span>conflict.analysis = generateAnalysis(rel, v.users, conflict.partnerIntakes);</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  </span><span class="s1">await</span> saveVault();</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  </span>state.view = <span class="s4">"SAFETY"</span>;</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  </span>render();</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  Â  Â  </span>toast(</span>"Safety flags detected. Pivoting."<span class="s5">);</span></p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  </span><span class="s1">return</span>;</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>}</p>
<p class="p4"><br></p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span><span class="s1">await</span> saveVault();</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  Â  </span>toast(</span>"Saved intake."<span class="s5">);</span></p>
<p class="p4"><br></p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span><span class="s1">const</span> nextPartner = (partnerId === rel.memberIds[<span class="s3">0</span>]) ? rel.memberIds[<span class="s3">1</span>] : <span class="s6">null</span>;</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span><span class="s1">if</span> (nextPartner) {</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  </span>state.selected.activePartnerId = nextPartner;</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  </span>render();</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>} <span class="s1">else</span> {</p>
<p class="p5"><span class="s5"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span>// both done, analyze</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  </span>conflict.analysis = generateAnalysis(rel, v.users, conflict.partnerIntakes);</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  </span><span class="s1">await</span> saveVault();</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  </span>state.view = conflict.analysis.safetyPivot ? <span class="s4">"SAFETY"</span> : <span class="s4">"REPORT"</span>;</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  </span>render();</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>}</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>}},[document.createTextNode(<span class="s4">"Save + Continue"</span>)]),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>el(<span class="s4">"button"</span>,{<span class="s3">class</span>:<span class="s4">"btn"</span>, <span class="s3">onclick</span>:()=&gt;go(<span class="s4">"DASH"</span>)},[document.createTextNode(<span class="s4">"Exit to Dashboard"</span>)]),</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>]));</p>
<p class="p4"><br></p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> status = el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"hint"</span>, <span class="s3">html</span>:</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span></span>`Progress: A=<span class="s2">${hasA?</span>"âœ…"<span class="s2">:</span>"â¬œ"<span class="s2">}</span> Â· B=<span class="s2">${hasB?</span>"âœ…"<span class="s2">:</span>"â¬œ"<span class="s2">}</span>`</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>});</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>box.append(status);</p>
<p class="p4"><br></p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">return</span> box;</p>
<p class="p2">}</p>
<p class="p4"><br></p>
<p class="p2"><span class="s1">function</span> renderSafety() {</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> v = state.vault;</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> rel = currentRelationship();</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> conflict = v.conflicts.find(c=&gt;c.id===state.selected.conflictId);</p>
<p class="p4"><br></p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> box = el(<span class="s4">"div"</span>,{},[</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span>el(</span>"h2"<span class="s5">,{</span><span class="s3">html</span><span class="s5">:</span>"Safety Pivot (Not a standard â€˜conflictâ€™)"<span class="s5"> }),</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span>el(</span>"div"<span class="s5">,{</span><span class="s3">class</span><span class="s5">:</span>"dangerBox"<span class="s5">, </span><span class="s3">html</span><span class="s5">:</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  Â  </span></span>"&lt;b&gt;This looks like it may include coercion, threats, violence, or outing risk.&lt;/b&gt;&lt;br&gt;"<span class="s5"> +</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  Â  </span></span>"That changes the job. The priority is safety, not â€˜communication skillsâ€™."</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>}),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"hr"</span>}),</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>]);</p>
<p class="p4"><br></p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> findings = conflict?.analysis?.safetyFindings || [];</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">if</span> (findings.length) {</p>
<p class="p3"><span class="s5"><span class="Apple-converted-space">Â  Â  </span></span><span class="s1">const</span><span class="s5"> items = findings.map(f =&gt; </span><span class="s4">`â€¢ </span>${escapeHtml(userById(f.partnerId)?.displayName||<span class="s4">"Partner"</span>)}<span class="s4">: </span>${escapeHtml(f.type)}<span class="s4">`</span><span class="s5">).join(</span><span class="s4">"&lt;br&gt;"</span><span class="s5">);</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span>box.append(el(</span>"div"<span class="s5">,{</span><span class="s3">class</span><span class="s5">:</span>"warnBox"<span class="s5">, </span><span class="s3">html</span><span class="s5">:</span>`&lt;b&gt;Detected signals:&lt;/b&gt;&lt;br&gt;<span class="s2">${items}</span>`<span class="s5">}));</span></p>
<p class="p2"><span class="Apple-converted-space">Â  </span>}</p>
<p class="p4"><br></p>
<p class="p2"><span class="Apple-converted-space">Â  </span>box.append(</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"hr"</span>}),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"muted"</span>, <span class="s3">html</span>:</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  Â  </span></span>"&lt;b&gt;What this app will tell you (bluntly):&lt;/b&gt;&lt;br&gt;"<span class="s5"> +</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  Â  </span></span>"â€¢ Threats, coercion, violence, or outing risk are not â€˜relationship problemsâ€™. Theyâ€™re safety problems.&lt;br&gt;"<span class="s5"> +</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  Â  </span></span>"â€¢ If either person is unsafe, do not do live conflict sessions. Get support and make a safety plan."</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>}),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"hr"</span>}),</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span>el(</span>"div"<span class="s5">,{</span><span class="s3">class</span><span class="s5">:</span>"goodBox"<span class="s5">, </span><span class="s3">html</span><span class="s5">:</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  Â  </span></span>"&lt;b&gt;UK resources:&lt;/b&gt;&lt;br&gt;"<span class="s5"> +</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  Â  </span></span>"â€¢ Samaritans (24/7 listening): &lt;a target='_blank' rel='noreferrer' href='https://www.samaritans.org/how-we-can-help/contact-samaritan/talk-us-phone/'&gt;samaritans.org&lt;/a&gt;&lt;br&gt;"<span class="s5"> +</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  Â  </span></span>"â€¢ NHS 111: &lt;a target='_blank' rel='noreferrer' href='https://www.nhs.uk/nhs-services/urgent-and-emergency-care-services/when-to-use-111/'&gt;nhs.uk&lt;/a&gt;&lt;br&gt;"<span class="s5"> +</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  Â  </span></span>"â€¢ Refuge National Domestic Abuse Helpline: &lt;a target='_blank' rel='noreferrer' href='https://refuge.org.uk/i-need-help-now/how-we-can-help-you/national-domestic-abuse-helpline/'&gt;refuge.org.uk&lt;/a&gt;&lt;br&gt;"<span class="s5"> +</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  Â  </span></span>"â€¢ Galop LGBT+ anti-abuse helpline: &lt;a target='_blank' rel='noreferrer' href='https://www.galop.org.uk/contact-us'&gt;galop.org.uk&lt;/a&gt;&lt;br&gt;"<span class="s5"> +</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  Â  </span></span>"&lt;br&gt;&lt;b&gt;If you are in immediate danger:&lt;/b&gt; call your local emergency number."</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>}),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"hr"</span>}),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"row"</span>},[</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>el(<span class="s4">"button"</span>,{<span class="s3">class</span>:<span class="s4">"btn"</span>, <span class="s3">onclick</span>:()=&gt;go(<span class="s4">"HISTORY"</span>)},[document.createTextNode(<span class="s4">"Go to History"</span>)]),</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  Â  </span>el(</span>"button"<span class="s5">,{</span><span class="s3">class</span><span class="s5">:</span>"btn primary"<span class="s5">, </span><span class="s3">onclick</span><span class="s5">:()=&gt;{</span></p>
<p class="p5"><span class="s5"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span>// allow viewing report but keep framed</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  </span>state.view = <span class="s4">"REPORT"</span>;</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  </span>render();</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>}},[document.createTextNode(<span class="s4">"View Report (with caution)"</span>)]),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>])</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>);</p>
<p class="p4"><br></p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">return</span> box;</p>
<p class="p2">}</p>
<p class="p4"><br></p>
<p class="p2"><span class="s1">function</span> renderReport() {</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> v = state.vault;</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> rel = currentRelationship();</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> conflict = v.conflicts.find(c=&gt;c.id===state.selected.conflictId);</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> analysis = conflict?.analysis;</p>
<p class="p4"><br></p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> box = el(<span class="s4">"div"</span>,{},[</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span>el(</span>"h2"<span class="s5">,{</span><span class="s3">html</span><span class="s5">:</span>"Conflict Report"<span class="s5">}),</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span>el(</span>"div"<span class="s5">,{</span><span class="s3">class</span><span class="s5">:</span>"muted"<span class="s5">, </span><span class="s3">html</span><span class="s5">:</span>"Shareable couple summary + private partner feedback. Blunt about behaviors, not identity."<span class="s5">}),</span></p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"hr"</span>}),</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>]);</p>
<p class="p4"><br></p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">if</span> (!analysis) {</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span>box.append(el(</span>"div"<span class="s5">,{</span><span class="s3">class</span><span class="s5">:</span>"warnBox"<span class="s5">, </span><span class="s3">html</span><span class="s5">:</span>"No analysis found. Complete both intakes first."<span class="s5">}));</span></p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span><span class="s1">return</span> box;</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>}</p>
<p class="p4"><br></p>
<p class="p5"><span class="s5"><span class="Apple-converted-space">Â  </span></span>// Couple summary</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>box.append(</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span>el(</span>"div"<span class="s5">,{</span><span class="s3">class</span><span class="s5">:</span>"card"<span class="s5">, </span><span class="s3">style</span><span class="s5">:</span>"padding:12px"<span class="s5">},[</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  Â  </span>el(</span>"h2"<span class="s5">,{</span><span class="s3">html</span><span class="s5">:</span>"Couple Summary"<span class="s5">}),</span></p>
<p class="p3"><span class="s5"><span class="Apple-converted-space">Â  Â  Â  </span>el(</span><span class="s4">"div"</span><span class="s5">,{</span><span class="s3">class</span><span class="s5">:</span><span class="s4">"goodBox"</span><span class="s5">, </span><span class="s3">html</span><span class="s5">:</span><span class="s4">`&lt;b&gt;</span>${escapeHtml(analysis.coupleSummary.headline)}<span class="s4">&lt;/b&gt;`</span><span class="s5">}),</span></p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"hr"</span>}),</p>
<p class="p3"><span class="s5"><span class="Apple-converted-space">Â  Â  Â  </span>el(</span><span class="s4">"div"</span><span class="s5">,{</span><span class="s3">class</span><span class="s5">:</span><span class="s4">"muted"</span><span class="s5">, </span><span class="s3">html</span><span class="s5">:</span><span class="s4">`&lt;b&gt;Pattern detected:&lt;/b&gt; </span>${escapeHtml(analysis.coupleSummary.pattern)}<span class="s4">`</span><span class="s5">}),</span></p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"hr"</span>}),</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  Â  </span>el(</span>"label"<span class="s5">,{</span><span class="s3">html</span><span class="s5">:</span>"Neutral facts summary (combined)"<span class="s5">}),</span></p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>el(<span class="s4">"textarea"</span>,{<span class="s3">readonly</span>:<span class="s6">true</span>},[]),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>])</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>);</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>box.querySelector(<span class="s4">"textarea[readonly]"</span>).value = analysis.coupleSummary.neutralFacts;</p>
<p class="p4"><br></p>
<p class="p5"><span class="s5"><span class="Apple-converted-space">Â  </span></span>// Blunt truths</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>box.append(el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"hr"</span>}));</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  </span>box.append(el(</span>"div"<span class="s5">,{</span><span class="s3">class</span><span class="s5">:</span>"warnBox"<span class="s5">, </span><span class="s3">html</span><span class="s5">:</span>`&lt;b&gt;Blunt truths (because you asked):&lt;/b&gt;&lt;br&gt;<span class="s2">${analysis.bluntTruths.map(t=&gt;</span>"â€¢ "<span class="s2">+escapeHtml(t)).join(</span>"&lt;br&gt;"<span class="s2">)}</span>`<span class="s5">}));</span></p>
<p class="p4"><br></p>
<p class="p5"><span class="s5"><span class="Apple-converted-space">Â  </span></span>// Non-negotiables</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">if</span> (analysis.nonNegotiables?.length) {</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>box.append(el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"hr"</span>}));</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span>box.append(el(</span>"div"<span class="s5">,{</span><span class="s3">class</span><span class="s5">:</span>"dangerBox"<span class="s5">, </span><span class="s3">html</span><span class="s5">:</span>`&lt;b&gt;Non-negotiables to stop:&lt;/b&gt;&lt;br&gt;<span class="s2">${analysis.nonNegotiables.map(t=&gt;</span>"â€¢ "<span class="s2">+escapeHtml(t)).join(</span>"&lt;br&gt;"<span class="s2">)}</span>`<span class="s5">}));</span></p>
<p class="p2"><span class="Apple-converted-space">Â  </span>}</p>
<p class="p4"><br></p>
<p class="p5"><span class="s5"><span class="Apple-converted-space">Â  </span></span>// Partner sections</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>box.append(el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"hr"</span>}));</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">for</span> (<span class="s1">const</span> p <span class="s1">of</span> Object.values(analysis.perPartner)) {</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span><span class="s1">const</span> fairness = p.fairnessAreas.length ? p.fairnessAreas.map(a=&gt;<span class="s4">`&lt;span class="badge"&gt;</span><span class="s2">${escapeHtml(a)}</span><span class="s4">&lt;/span&gt;`</span>).join(<span class="s4">" "</span>) : <span class="s4">"&lt;span class='small'&gt;None selected&lt;/span&gt;"</span>;</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span></span><span class="s1">const</span><span class="s5"> d = p.distortions?.length ? p.distortions.map(x=&gt;</span>`â€¢ &lt;b&gt;<span class="s2">${escapeHtml(x.name)}</span>:&lt;/b&gt; <span class="s2">${escapeHtml(x.tip)}</span>`<span class="s5">).join(</span>"&lt;br&gt;"<span class="s5">) : </span>"â€¢ None detected from text (or you were unusually careful, congrats)."<span class="s5">;</span></p>
<p class="p4"><br></p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span><span class="s1">const</span> green = p.green.length ? p.green.map(x=&gt;<span class="s4">"â€¢ "</span>+escapeHtml(x)).join(<span class="s4">"&lt;br&gt;"</span>) : <span class="s4">"â€¢ (none checked)"</span>;</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span><span class="s1">const</span> yellow = p.yellow.length ? p.yellow.map(x=&gt;<span class="s4">"â€¢ "</span>+escapeHtml(x)).join(<span class="s4">"&lt;br&gt;"</span>) : <span class="s4">"â€¢ (none checked)"</span>;</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span><span class="s1">const</span> red = p.red.length ? p.red.map(x=&gt;<span class="s4">"â€¢ "</span>+escapeHtml(x)).join(<span class="s4">"&lt;br&gt;"</span>) : <span class="s4">"â€¢ (none checked)"</span>;</p>
<p class="p4"><br></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span>box.append(el(</span>"div"<span class="s5">,{</span><span class="s3">class</span><span class="s5">:</span>"card"<span class="s5">, </span><span class="s3">style</span><span class="s5">:</span>"padding:12px; margin-top:12px"<span class="s5">},[</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  Â  </span>el(</span>"h2"<span class="s5">,{</span><span class="s3">html</span><span class="s5">:</span>`Private Feedback: <span class="s2">${escapeHtml(p.name)}</span>`<span class="s5">}),</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  Â  </span>el(</span>"div"<span class="s5">,{</span><span class="s3">class</span><span class="s5">:</span>"muted"<span class="s5">, </span><span class="s3">html</span><span class="s5">:</span>`Behavior score: &lt;span class="mono"&gt;<span class="s2">${p.behaviorsScore.score}</span>&lt;/span&gt; (Green +2, Yellow âˆ’1, Red âˆ’3)`<span class="s5">}),</span></p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"hr"</span>}),</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  Â  </span>el(</span>"div"<span class="s5">,{</span><span class="s3">class</span><span class="s5">:</span>"muted"<span class="s5">, </span><span class="s3">html</span><span class="s5">:</span>`&lt;b&gt;Fairness areas flagged:&lt;/b&gt; <span class="s2">${fairness}</span>`<span class="s5">}),</span></p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"hr"</span>}),</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  Â  </span>el(</span>"div"<span class="s5">,{</span><span class="s3">class</span><span class="s5">:</span>"goodBox"<span class="s5">, </span><span class="s3">html</span><span class="s5">:</span>`&lt;b&gt;Green (fair/respectful):&lt;/b&gt;&lt;br&gt;<span class="s2">${green}</span>`<span class="s5">}),</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  Â  </span>el(</span>"div"<span class="s5">,{</span><span class="s3">class</span><span class="s5">:</span>"warnBox"<span class="s5">, </span><span class="s3">html</span><span class="s5">:</span>`&lt;b&gt;Yellow (problematic but repairable):&lt;/b&gt;&lt;br&gt;<span class="s2">${yellow}</span>`<span class="s5">}),</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  Â  </span>el(</span>"div"<span class="s5">,{</span><span class="s3">class</span><span class="s5">:</span>"dangerBox"<span class="s5">, </span><span class="s3">html</span><span class="s5">:</span>`&lt;b&gt;Red (unfair/harmful):&lt;/b&gt;&lt;br&gt;<span class="s2">${red}</span>`<span class="s5">}),</span></p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"hr"</span>}),</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  Â  </span>el(</span>"div"<span class="s5">,{</span><span class="s3">class</span><span class="s5">:</span>"warnBox"<span class="s5">, </span><span class="s3">html</span><span class="s5">:</span>`&lt;b&gt;Cognitive distortions to fix:&lt;/b&gt;&lt;br&gt;<span class="s2">${d}</span>`<span class="s5">}),</span></p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"hr"</span>}),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"goodBox"</span>, <span class="s3">html</span>:</p>
<p class="p3"><span class="s5"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s4">`&lt;b&gt;Repair script (copy/paste):&lt;/b&gt;&lt;br&gt;</span>${analysis.repairs[p.partnerId].map(s=&gt;<span class="s4">"â€¢ "</span>+escapeHtml(s)).join(<span class="s4">"&lt;br&gt;"</span>)}<span class="s4">`</span></p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>}),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>]));</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>}</p>
<p class="p4"><br></p>
<p class="p5"><span class="s5"><span class="Apple-converted-space">Â  </span></span>// Boundary tips</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>box.append(el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"hr"</span>}));</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  </span>box.append(el(</span>"div"<span class="s5">,{</span><span class="s3">class</span><span class="s5">:</span>"goodBox"<span class="s5">, </span><span class="s3">html</span><span class="s5">:</span>`&lt;b&gt;Boundary &amp; behavior tips (concrete):&lt;/b&gt;&lt;br&gt;<span class="s2">${analysis.boundaryTips.map(t=&gt;</span>"â€¢ "<span class="s2">+escapeHtml(t)).join(</span>"&lt;br&gt;"<span class="s2">)}</span>`<span class="s5">}));</span></p>
<p class="p4"><br></p>
<p class="p2"><span class="Apple-converted-space">Â  </span>box.append(el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"hr"</span>}));</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>box.append(el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"row"</span>},[</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>el(<span class="s4">"button"</span>,{<span class="s3">class</span>:<span class="s4">"btn"</span>, <span class="s3">onclick</span>:()=&gt;go(<span class="s4">"HISTORY"</span>)},[document.createTextNode(<span class="s4">"Back to History"</span>)]),</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span>el(</span>"button"<span class="s5">,{</span><span class="s3">class</span><span class="s5">:</span>"btn primary"<span class="s5">, </span><span class="s3">onclick</span><span class="s5">:()=&gt;go(</span>"NEW_CONFLICT"<span class="s5">)},[document.createTextNode(</span>"Start Another Conflict"<span class="s5">)]),</span></p>
<p class="p2"><span class="Apple-converted-space">Â  </span>]));</p>
<p class="p4"><br></p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">return</span> box;</p>
<p class="p2">}</p>
<p class="p4"><br></p>
<p class="p2"><span class="s1">function</span> renderHistory() {</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> v = state.vault;</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> box = el(<span class="s4">"div"</span>,{},[</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>el(<span class="s4">"h2"</span>,{<span class="s3">html</span>:<span class="s4">"History"</span>}),</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span>el(</span>"div"<span class="s5">,{</span><span class="s3">class</span><span class="s5">:</span>"muted"<span class="s5">, </span><span class="s3">html</span><span class="s5">:</span>"All conflicts stored locally in your encrypted vault."<span class="s5">}),</span></p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"hr"</span>}),</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>]);</p>
<p class="p4"><br></p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">if</span> (!v.conflicts.length) {</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span>box.append(el(</span>"div"<span class="s5">,{</span><span class="s3">class</span><span class="s5">:</span>"muted"<span class="s5">, </span><span class="s3">html</span><span class="s5">:</span>"No conflict sessions yet."<span class="s5">}));</span></p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span><span class="s1">return</span> box;</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>}</p>
<p class="p4"><br></p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> list = el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"list"</span>},[]);</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> relById = (id)=&gt; v.relationships.find(r=&gt;r.id===id);</p>
<p class="p4"><br></p>
<p class="p2"><span class="Apple-converted-space">Â  </span>[...v.conflicts].sort((a,b)=&gt; (b.createdAt||<span class="s4">""</span>).localeCompare(a.createdAt||<span class="s4">""</span>)).forEach(c=&gt;{</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span><span class="s1">const</span> r = relById(c.relationshipId);</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span><span class="s1">const</span> a = c.analysis;</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span><span class="s1">const</span> badge = a?.safetyPivot ? {<span class="s3">txt</span>:<span class="s4">"Safety"</span>, <span class="s3">cls</span>:<span class="s4">"bR"</span>} : (a ? {<span class="s3">txt</span>:<span class="s4">"Analyzed"</span>, <span class="s3">cls</span>:<span class="s4">"bG"</span>} : {<span class="s3">txt</span>:<span class="s4">"In progress"</span>, <span class="s3">cls</span>:<span class="s4">"bY"</span>});</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>list.append(el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"item"</span>},[</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>el(<span class="s4">"div"</span>,{},[</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  Â  Â  </span>el(</span>"div"<span class="s5">,{</span><span class="s3">html</span><span class="s5">:</span>`&lt;b&gt;<span class="s2">${escapeHtml(r?.name||</span>"Relationship"<span class="s2">)}</span>&lt;/b&gt; &lt;span class="badge <span class="s2">${badge.cls}</span>"&gt;<span class="s2">${badge.txt}</span>&lt;/span&gt;`<span class="s5">}),</span></p>
<p class="p3"><span class="s5"><span class="Apple-converted-space">Â  Â  Â  Â  </span>el(</span><span class="s4">"div"</span><span class="s5">,{</span><span class="s3">class</span><span class="s5">:</span><span class="s4">"small"</span><span class="s5">, </span><span class="s3">html</span><span class="s5">:</span><span class="s4">`</span>${<span class="s1">new</span> Date(c.createdAt).toLocaleString()}<span class="s4"> Â· mode: </span>${escapeHtml(c.mode)}<span class="s4"> Â· outcome: </span>${escapeHtml(c.outcome)}<span class="s4">`</span><span class="s5">})</span></p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>]),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"inline"</span>},[</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  </span>el(<span class="s4">"button"</span>,{<span class="s3">class</span>:<span class="s4">"btn"</span>, <span class="s3">onclick</span>:()=&gt;{</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  Â  </span>state.selected.relationshipId = c.relationshipId;</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  Â  </span>state.selected.conflictId = c.id;</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  Â  </span>state.view = a?.safetyPivot ? <span class="s4">"SAFETY"</span> : <span class="s4">"REPORT"</span>;</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  Â  </span>render();</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  </span>}},[document.createTextNode(<span class="s4">"Open"</span>)]),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  </span>el(<span class="s4">"button"</span>,{<span class="s3">class</span>:<span class="s4">"btn danger"</span>, <span class="s3">onclick</span>:async()=&gt;{</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  Â  Â  Â  </span></span><span class="s1">if</span><span class="s5"> (!confirm(</span>"Delete this conflict session?"<span class="s5">)) </span><span class="s1">return</span><span class="s5">;</span></p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  Â  </span>v.conflicts = v.conflicts.filter(x=&gt;x.id!==c.id);</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  Â  </span><span class="s1">await</span> saveVault();</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  Â  </span>render();</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  Â  </span>toast(<span class="s4">"Deleted."</span>);</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  </span>}},[document.createTextNode(<span class="s4">"Delete"</span>)]),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>])</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>]));</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>});</p>
<p class="p4"><br></p>
<p class="p2"><span class="Apple-converted-space">Â  </span>box.append(list);</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">return</span> box;</p>
<p class="p2">}</p>
<p class="p4"><br></p>
<p class="p2"><span class="s1">function</span> renderSettings() {</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> v = state.vault;</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> box = el(<span class="s4">"div"</span>,{},[</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span>el(</span>"h2"<span class="s5">,{</span><span class="s3">html</span><span class="s5">:</span>"Settings"<span class="s5">}),</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span>el(</span>"div"<span class="s5">,{</span><span class="s3">class</span><span class="s5">:</span>"muted"<span class="s5">, </span><span class="s3">html</span><span class="s5">:</span>"Privacy-first controls. Stealth mode exists because reality exists."<span class="s5">}),</span></p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"hr"</span>}),</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>]);</p>
<p class="p4"><br></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  </span></span><span class="s1">const</span><span class="s5"> stealth = checkbox(</span>"Enable stealth mode (neutral app name/icon)"<span class="s5">, v.settings.stealth);</span></p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> autoLock = input(v.settings.autoLockMinutes, {<span class="s3">type</span>:<span class="s4">"number"</span>, <span class="s3">min</span>:<span class="s4">"1"</span>, <span class="s3">max</span>:<span class="s4">"120"</span>});</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  </span></span><span class="s1">const</span><span class="s5"> pin = input(</span>""<span class="s5">, {</span><span class="s3">type</span><span class="s5">:</span>"password"<span class="s5">, </span><span class="s3">placeholder</span><span class="s5">:</span>"Set a new PIN"<span class="s5">});</span></p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> lockNow = el(<span class="s4">"button"</span>,{<span class="s3">class</span>:<span class="s4">"btn"</span>, <span class="s3">onclick</span>:()=&gt;doLock(<span class="s4">"Locked."</span>)},[document.createTextNode(<span class="s4">"Lock now"</span>)]);</p>
<p class="p4"><br></p>
<p class="p2"><span class="Apple-converted-space">Â  </span>box.append(</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>stealth.node,</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>formRow(<span class="s4">"Auto-lock minutes"</span>, autoLock),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"hr"</span>}),</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span>el(</span>"div"<span class="s5">,{</span><span class="s3">class</span><span class="s5">:</span>"warnBox"<span class="s5">, </span><span class="s3">html</span><span class="s5">:</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  Â  </span></span>"&lt;b&gt;Optional PIN:&lt;/b&gt; Convenience only. Passphrase is still your real protection. PIN is weaker by nature."</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>}),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>formRow(<span class="s4">"Set/replace PIN"</span>, pin),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"row"</span>},[</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>el(<span class="s4">"button"</span>,{<span class="s3">class</span>:<span class="s4">"btn primary"</span>, <span class="s3">onclick</span>:async()=&gt;{</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  </span>v.settings.stealth = stealth.get();</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  </span>v.settings.autoLockMinutes = parseInt(autoLock.value||<span class="s4">"10"</span>,<span class="s3">10</span>);</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  </span><span class="s1">if</span> (pin.value.trim()) <span class="s1">await</span> setPin(pin.value.trim());</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  </span><span class="s1">await</span> saveVault();</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  </span>applyBranding();</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  Â  </span>render();</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  Â  Â  </span>toast(</span>"Settings saved."<span class="s5">);</span></p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>}},[document.createTextNode(<span class="s4">"Save Settings"</span>)]),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>lockNow</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>]),</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"hr"</span>}),</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  </span>el(</span>"div"<span class="s5">,{</span><span class="s3">class</span><span class="s5">:</span>"dangerBox"<span class="s5">, </span><span class="s3">html</span><span class="s5">:</span></p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  Â  Â  </span></span>"&lt;b&gt;Data location:&lt;/b&gt; This app stores an encrypted blob in your browser's LocalStorage. Clearing site data deletes it."</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>})</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>);</p>
<p class="p4"><br></p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">return</span> box;</p>
<p class="p2">}</p>
<p class="p4"><br></p>
<p class="p5">/** -----------------------------</p>
<p class="p5"><span class="Apple-converted-space">Â </span>*<span class="Apple-converted-space">Â  </span>CRUD actions</p>
<p class="p5"><span class="Apple-converted-space">Â </span>*<span class="Apple-converted-space">Â  </span>----------------------------- */</p>
<p class="p2"><span class="s1">function</span> editUser(id){ state._editingUserId = id; go(<span class="s4">"NEW_USER"</span>); }</p>
<p class="p2"><span class="s1">async</span> <span class="s1">function</span> deleteUser(id){</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  </span></span><span class="s1">if</span><span class="s5"> (!confirm(</span>"Delete this user? This may break relationships/conflicts."<span class="s5">)) </span><span class="s1">return</span><span class="s5">;</span></p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> v = state.vault;</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>v.users = v.users.filter(u=&gt;u.id!==id);</p>
<p class="p5"><span class="s5"><span class="Apple-converted-space">Â  </span></span>// clean up relationships</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>v.relationships = v.relationships.filter(r=&gt;!r.memberIds.includes(id));</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">await</span> saveVault();</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>render();</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  </span>toast(</span>"Deleted user + related relationships."<span class="s5">);</span></p>
<p class="p2">}</p>
<p class="p2"><span class="s1">function</span> editRel(id){ state._editingRelId = id; go(<span class="s4">"NEW_REL"</span>); }</p>
<p class="p2"><span class="s1">async</span> <span class="s1">function</span> deleteRel(id){</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  </span></span><span class="s1">if</span><span class="s5"> (!confirm(</span>"Delete this relationship and its conflicts?"<span class="s5">)) </span><span class="s1">return</span><span class="s5">;</span></p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> v = state.vault;</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>v.relationships = v.relationships.filter(r=&gt;r.id!==id);</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>v.conflicts = v.conflicts.filter(c=&gt;c.relationshipId!==id);</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">if</span> (state.selected.relationshipId===id) state.selected.relationshipId = <span class="s6">null</span>;</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">await</span> saveVault();</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>render();</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>toast(<span class="s4">"Deleted."</span>);</p>
<p class="p2">}</p>
<p class="p4"><br></p>
<p class="p5">/** -----------------------------</p>
<p class="p5"><span class="Apple-converted-space">Â </span>*<span class="Apple-converted-space">Â  </span>Form components</p>
<p class="p5"><span class="Apple-converted-space">Â </span>*<span class="Apple-converted-space">Â  </span>----------------------------- */</p>
<p class="p2"><span class="s1">function</span> escapeHtml(s=<span class="s4">""</span>){</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  </span></span><span class="s1">return</span><span class="s5"> String(s).replace(</span>/[&amp;&lt;&gt;"']/g<span class="s5">, m =&gt; ({</span>'&amp;'<span class="s5">:</span>'&amp;amp;'<span class="s5">,</span>'&lt;'<span class="s5">:</span>'&amp;lt;'<span class="s5">,</span>'&gt;'<span class="s5">:</span>'&amp;gt;'<span class="s5">,</span>'"'<span class="s5">:</span>'&amp;quot;'<span class="s5">,</span>"'"<span class="s5">:</span>'&amp;#39;'<span class="s5">}[m]));</span></p>
<p class="p2">}</p>
<p class="p2"><span class="s1">function</span> input(val=<span class="s4">""</span>, attrs={}) {</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> n = el(<span class="s4">"input"</span>, {<span class="s3">value</span>: val, ...attrs});</p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">Â  </span></span>return<span class="s5"> n;</span></p>
<p class="p2">}</p>
<p class="p2"><span class="s1">function</span> textarea(val=<span class="s4">""</span>) {</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> n = el(<span class="s4">"textarea"</span>,{});</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>n.value = val;</p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">Â  </span></span>return<span class="s5"> n;</span></p>
<p class="p2">}</p>
<p class="p2"><span class="s1">function</span> select(options=[], selected=<span class="s6">null</span>) {</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> n = el(<span class="s4">"select"</span>,{});</p>
<p class="p5"><span class="s5"><span class="Apple-converted-space">Â  </span></span>// options can be array of strings or ids; allow mapping labels later</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">for</span> (<span class="s1">const</span> o <span class="s1">of</span> options) {</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span><span class="s1">const</span> opt = el(<span class="s4">"option"</span>,{<span class="s3">value</span>:o, <span class="s3">html</span>: escapeHtml(String(o))});</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span><span class="s1">if</span> (String(o)===String(selected)) opt.selected = <span class="s6">true</span>;</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>n.append(opt);</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>}</p>
<p class="p5"><span class="s5"><span class="Apple-converted-space">Â  </span></span>// if _render exists, caller can replace labels manually; (kept minimal)</p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">Â  </span></span>return<span class="s5"> n;</span></p>
<p class="p2">}</p>
<p class="p2"><span class="s1">function</span> formRow(labelText, node, extra={}) {</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> wrap = el(<span class="s4">"div"</span>,{});</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>wrap.append(el(<span class="s4">"label"</span>,{<span class="s3">html</span>: escapeHtml(labelText)}));</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">if</span> (extra.labels &amp;&amp; node.tagName===<span class="s4">"SELECT"</span>) {</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>node.innerHTML=<span class="s4">""</span>;</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span><span class="s1">for</span> (<span class="s1">const</span> it <span class="s1">of</span> extra.labels) {</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span><span class="s1">const</span> opt = el(<span class="s4">"option"</span>,{<span class="s3">value</span>:it.value, <span class="s3">html</span>: escapeHtml(it.label)});</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span><span class="s1">if</span> (node.value===it.value) opt.selected = <span class="s6">true</span>;</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span>node.append(opt);</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>}</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>}</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>wrap.append(node);</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">return</span> wrap;</p>
<p class="p2">}</p>
<p class="p2"><span class="s1">function</span> checkbox(labelText, checked=<span class="s6">false</span>) {</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> cb = el(<span class="s4">"input"</span>,{<span class="s3">type</span>:<span class="s4">"checkbox"</span>});</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>cb.checked = checked;</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> node = el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"check"</span>},[</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>cb,</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>el(<span class="s4">"span"</span>,{<span class="s3">html</span>: escapeHtml(labelText)})</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>]);</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">return</span> { node, <span class="s3">get</span>:()=&gt;cb.checked, <span class="s3">set</span>:(v)=&gt;cb.checked=!!v };</p>
<p class="p2">}</p>
<p class="p2"><span class="s1">function</span> multiSelect(options, selectedArr) {</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> set = <span class="s1">new</span> Set(selectedArr||[]);</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> node = el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"checkRow"</span>}, options.map(o=&gt;{</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span><span class="s1">const</span> c = checkbox(o, set.has(o));</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>c._key = o;</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span><span class="s1">return</span> c.node;</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>}));</p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">Â  </span></span>return<span class="s5"> {</span></p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>node,</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span><span class="s3">get</span>:()=&gt; [...node.querySelectorAll(<span class="s4">"input[type=checkbox]"</span>)].map((x,i)=&gt; x.checked ? options[i] : <span class="s6">null</span>).filter(Boolean)</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>};</p>
<p class="p2">}</p>
<p class="p2"><span class="s1">function</span> renderChecks(arr, existingBehaviors) {</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> wrap = el(<span class="s4">"div"</span>,{<span class="s3">class</span>:<span class="s4">"checkRow"</span>},[]);</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">for</span> (<span class="s1">const</span> b <span class="s1">of</span> arr) {</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span><span class="s1">const</span> c = checkbox(b.t, !!existingBehaviors?.[b.k]);</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>c.node.dataset.key = b.k;</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>wrap.append(c.node);</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>}</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">return</span> wrap;</p>
<p class="p2">}</p>
<p class="p2"><span class="s1">function</span> readBehaviors(root) {</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> out = {};</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>root.querySelectorAll(<span class="s4">"[data-key] input[type=checkbox]"</span>).forEach(cb=&gt;{</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span><span class="s1">const</span> k = cb.closest(<span class="s4">"[data-key]"</span>).dataset.key;</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>out[k] = cb.checked;</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>});</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">return</span> out;</p>
<p class="p2">}</p>
<p class="p2"><span class="s1">function</span> parseEmotions(text) {</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">return</span> text.split(<span class="s4">"\n"</span>).map(s=&gt;s.trim()).filter(Boolean).map(line=&gt;{</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span><span class="s1">const</span> [name, intensity] = line.split(<span class="s4">":"</span>).map(x=&gt;x?.trim());</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span><span class="s1">const</span> n = (intensity===<span class="s6">undefined</span>) ? <span class="s3">5</span> : Math.max(<span class="s3">0</span>, Math.min(<span class="s3">10</span>, parseInt(intensity,<span class="s3">10</span>) || <span class="s3">0</span>));</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span><span class="s1">return</span> { <span class="s3">name</span>: name || <span class="s4">"emotion"</span>, <span class="s3">intensity</span>: n };</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>});</p>
<p class="p2">}</p>
<p class="p4"><br></p>
<p class="p5">/** -----------------------------</p>
<p class="p5"><span class="Apple-converted-space">Â </span>*<span class="Apple-converted-space">Â  </span>Speech to text (Web Speech API)</p>
<p class="p5"><span class="Apple-converted-space">Â </span>*<span class="Apple-converted-space">Â  </span>----------------------------- */</p>
<p class="p2"><span class="s1">function</span> startSTT(targetTextarea) {</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> SR = window.SpeechRecognition || window.webkitSpeechRecognition;</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  </span></span><span class="s1">if</span><span class="s5"> (!SR) </span><span class="s1">return</span><span class="s5"> toast(</span>"Speech recognition not supported in this browser."<span class="s5">);</span></p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">const</span> rec = <span class="s1">new</span> SR();</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>rec.lang = <span class="s4">"en-GB"</span>;</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>rec.interimResults = <span class="s6">true</span>;</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>rec.continuous = <span class="s6">false</span>;</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">let</span> finalText = <span class="s4">""</span>;</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>rec.onresult = (e) =&gt; {</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span><span class="s1">let</span> interim = <span class="s4">""</span>;</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span><span class="s1">for</span> (<span class="s1">let</span> i = e.resultIndex; i &lt; e.results.length; i++) {</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span><span class="s1">const</span> t = e.results[i][<span class="s3">0</span>].transcript;</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span><span class="s1">if</span> (e.results[i].isFinal) finalText += t;</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  Â  </span><span class="s1">else</span> interim += t;</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>}</p>
<p class="p2"><span class="Apple-converted-space">Â  Â  </span>targetTextarea.value = (targetTextarea.value + (targetTextarea.value ? <span class="s4">" "</span> : <span class="s4">""</span>) + finalText + interim).trim();</p>
<p class="p2"><span class="Apple-converted-space">Â  </span>};</p>
<p class="p1"><span class="s5"><span class="Apple-converted-space">Â  </span>rec.onerror = () =&gt; toast(</span>"Speech-to-text error (permissions?)"<span class="s5">);</span></p>
<p class="p2"><span class="Apple-converted-space">Â  </span>rec.onend = () =&gt; toast(<span class="s4">"Speech-to-text stopped."</span>);</p>
<p class="p2"><span class="Apple-converted-space">Â  </span><span class="s1">try</span> { rec.start(); toast(<span class="s4">"Listening..."</span>); } <span class="s1">catch</span> { toast(<span class="s4">"Could not start STT."</span>); }</p>
<p class="p2">}</p>
<p class="p4"><br></p>
<p class="p5">/** -----------------------------</p>
<p class="p5"><span class="Apple-converted-space">Â </span>*<span class="Apple-converted-space">Â  </span>Controls</p>
<p class="p5"><span class="Apple-converted-space">Â </span>*<span class="Apple-converted-space">Â  </span>----------------------------- */</p>
<p class="p2">$(<span class="s4">"#lockBtn"</span>).addEventListener(<span class="s4">"click"</span>, ()=&gt;doLock(<span class="s4">"Locked."</span>));</p>
<p class="p2">applyBranding(<span class="s6">true</span>);</p>
<p class="p2">render();</p>
<p class="p4"><br></p>
<p class="p3"><span class="s5">&lt;/</span>script<span class="s5">&gt;</span></p>
<p class="p3"><span class="s5">&lt;/</span>body<span class="s5">&gt;</span></p>
<p class="p3"><span class="s5">&lt;/</span>html<span class="s5">&gt;</span></p>
</body>
</html>
